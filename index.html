<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praband - Teacher Authoring Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --radius-block: 1.5rem;
            --font-heading: 'Inter', sans-serif;
            --font-body: 'Inter', sans-serif;
            --entrance-anim: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-entrance {
            animation: var(--entrance-anim);
        }

        /* Update existing styles to use these variables where applicable */
        .bg-indigo-600 {
            background-color: var(--primary) !important;
        }

        .hover\:bg-indigo-700:hover {
            background-color: var(--primary-hover) !important;
        }

        .text-indigo-600 {
            color: var(--primary) !important;
        }

        .border-indigo-600 {
            border-color: var(--primary) !important;
        }

        .ring-indigo-500 {
            --tw-ring-color: var(--primary) !important;
        }

        /* Custom scrollbar for a cleaner feel */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }

        /* Sidebar Transitions */
        .sidebar {
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar.collapsed {
            width: 0 !important;
            min-width: 0 !important;
            border: none !important;
        }

        /* Resize Handle - Larger Hit Area */
        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            z-index: 50;
            transition: background-color 0.2s ease;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: transparent;
            transition: background-color 0.2s ease;
        }

        .resize-handle:hover::after,
        .resize-handle.active::after {
            background-color: #6366f1;
        }

        .resize-handle-left {
            right: -4px;
        }

        .resize-handle-left::after {
            right: 3px;
        }

        .resize-handle-right {
            left: -4px;
        }

        .resize-handle-right::after {
            left: 3px;
        }

        /* Toggle Button */
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .sidebar-toggle:hover {
            background: #f8fafc;
            border-color: #6366f1;
            height: 56px;
        }

        .sidebar-toggle-left {
            right: -12px;
            border-radius: 0 6px 6px 0;
        }

        .sidebar-toggle-right {
            left: -12px;
            border-radius: 6px 0 0 6px;
        }

        /* Keep toggles on screen edge when collapsed */
        .sidebar.collapsed .sidebar-toggle-left {
            right: -24px;
        }

        .sidebar.collapsed .sidebar-toggle-right {
            left: -24px;
        }

        /* Smooth content transitions */
        .sidebar-content {
            opacity: 1;
            transition: opacity 0.2s ease, visibility 0.2s;
            height: 100%;
            width: inherit;
            min-width: 200px;
        }

        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Prevent text selection during resize */
        body.is-resizing {
            user-select: none;
            cursor: col-resize;
        }

        /* Structured Sidebar Styles */
        .module-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .module-header:hover {
            background-color: #f1f5f9;
        }

        .module-group.collapsed .module-lessons {
            display: none;
        }

        .module-group.collapsed i[data-lucide="chevron-down"] {
            transform: rotate(-90deg);
        }

        .module-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
        }

        .lesson-item-new {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px 12px;
            margin-left: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .lesson-item-new:hover {
            background-color: #f8fafc;
        }

        .lesson-status {
            width: 18px;
            height: 18px;
            background-color: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .lesson-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            flex: 1;
            min-width: 0;
        }

        .lesson-name {
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lesson-meta {
            font-size: 11px;
            color: #94a3b8;
        }

        .lesson-item-new .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .lesson-item-new:hover .delete-btn {
            opacity: 1;
        }

        /* Drag and Drop State */
        .dragging {
            opacity: 0.5;
            background-color: #f1f5f9;
            border: 2px dashed #6366f1 !important;
        }

        .drag-handle {
            cursor: grab;
            color: #cbd5e1;
            padding: 4px;
            margin-top: -2px;
            transition: color 0.2s;
        }

        .drag-handle:hover {
            color: #6366f1;
        }

        .module-group.dragging {
            border: 2px dashed #6366f1;
            border-radius: 8px;
        }

        /* Editable States */
        [contenteditable="true"] {
            outline: none;
            transition: all 0.2s ease;
        }

        [contenteditable="true"]:focus {
            background-color: #f8fafc;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
            border-radius: 4px;
        }

        .bg-slate-900 [contenteditable="true"]:focus {
            background-color: rgba(255, 255, 255, 0.05);
            box-shadow: none;
        }

        /* Syntax Themes */
        .theme-midnight {
            background-color: #020617 !important;
            border-color: #1e1b4b !important;
        }

        .theme-midnight .text-purple-400 {
            color: #818cf8;
        }

        .theme-midnight .text-emerald-400 {
            color: #34d399;
        }

        .theme-forest {
            background-color: #064e3b !important;
            border-color: #065f46 !important;
        }

        .theme-forest .text-purple-400 {
            color: #fbbf24;
        }

        .theme-forest .text-emerald-400 {
            color: #6ee7b7;
        }

        .theme-forest .text-slate-300 {
            color: #d1fae5;
        }

        /* Master Prompt Tags & Toggles */
        .setting-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            background: #f1f5f9;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .setting-tag:hover {
            background: #e2e8f0;
        }

        .setting-tag.active {
            background: #eef2ff;
            color: #6366f1;
            border-color: #c7d2fe;
        }

        .ai-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #e2e8f0;
            font-size: 11px;
            font-weight: 500;
            color: #475569;
            transition: all 0.2s;
            margin-bottom: 6px;
        }

        .ai-action-btn:hover {
            border-color: #6366f1;
            background: #fdfeff;
            color: #6366f1;
            transform: translateY(-1px);
        }

        .sidebar-section-card {
            background: #fff;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .sidebar-section-card:hover {
            border-color: #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        }

        /* Figma Style Inspector Controls */
        .figma-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            color: #1e293b;
            width: 100%;
            transition: all 0.2s;
        }

        .figma-input:focus {
            outline: none;
            border-color: #6366f1;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .figma-label {
            font-size: 10px;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 4px;
            display: block;
        }

        .align-btn-group {
            display: flex;
            background: #f1f5f9;
            padding: 2px;
            border-radius: 6px;
        }

        .align-btn {
            flex: 1;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: #64748b;
            transition: all 0.2s;
        }

        .align-btn:hover {
            background: #e2e8f0;
            color: #1e293b;
        }

        .align-btn.active {
            background: #fff;
            color: #6366f1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Slash Menu Styles */
        .slash-menu {
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            animation: menuFadeIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slash-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slash-menu-item:hover {
            background-color: #f8fafc;
            padding-left: 18px;
        }

        .slash-menu-item i {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 8px;
            color: #64748b;
            transition: all 0.2s;
        }

        .slash-menu-item:hover i {
            background: #6366f1;
            color: white;
            transform: scale(1.1);
        }

        /* --- INTERACTIVE BLOCK CSS --- */

        /* 2. Flip Cards */
        .flip-container {
            perspective: 1000px;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 200px;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }

        .flip-card-inner.flipped {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        /* 3. Expandable Cards */
        .expand-vertical {
            max-height: 80px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .expand-vertical.expanded {
            max-height: 500px;
        }

        .expand-horizontal {
            width: 120px;
            transition: width 0.5s ease-in-out, background-color 0.3s;
        }

        .expand-horizontal.expanded {
            width: 320px;
        }

        /* 7. Hotspots */
        .hotspot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .shake {
            animation: shake 0.4s ease-in-out;
            border-color: #ef4444 !important;
        }

        .bar-chart-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            height: 200px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f1f5f9;
            margin-top: 10px;
        }

        .y-axis-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-right: 12px;
            border-right: 2px solid #f1f5f9;
        }

        .y-axis-label {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            white-space: nowrap;
        }

        .x-axis-labels {
            display: flex;
            justify-content: space-around;
            padding-top: 8px;
        }

        .bar-item {
            flex: 1;
            background: #6366f1;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            min-width: 30px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .bar-item:hover {
            background: #4f46e5;
            transform: scaleX(1.1);
        }

        .bar-tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .bar-item:hover .bar-tooltip {
            opacity: 1;
        }

        /* --- SMART UPLOAD COMPONENT CSS --- */
        .glass-dropzone {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 2px dashed rgba(99, 102, 241, 0.2);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .glass-dropzone:hover,
        .glass-dropzone.drag-over {
            background: rgba(99, 102, 241, 0.05);
            border-color: #6366f1;
            transform: scale(1.01);
        }

        .intent-card {
            background: white;
            border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }

        .intent-card:hover {
            border-color: #6366f1;
            box-shadow: 0 12px 24px -8px rgba(99, 102, 241, 0.15);
            transform: translateY(-4px);
        }

        .intent-card.active {
            border-color: #6366f1;
            background: #f5f8ff;
            box-shadow: 0 0 0 2px #6366f1;
        }

        /* Living Document / PDF Split View */
        .living-doc-section {
            border-left: 2px solid #e2e8f0;
            padding-left: 24px;
            position: relative;
            margin-bottom: 32px;
            transition: border-color 0.3s;
        }

        .living-doc-section:hover {
            border-color: #6366f1;
        }

        .living-doc-section::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 0;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: background 0.3s;
        }

        .living-doc-section:hover::before {
            background: #6366f1;
        }

        /* Video Pause Points */
        .video-marker {
            position: absolute;
            bottom: 0;
            width: 4px;
            height: 100%;
            background: #fbbf24;
            cursor: pointer;
            z-index: 10;
        }

        .marker-popup {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 140px;
            font-size: 10px;
            display: none;
        }

        .video-marker:hover .marker-popup,
        .hotspot:hover .marker-popup {
            display: block;
        }

        /* Quote Card Templates */
        .quote-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quote-card.template-classic {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
        }

        .quote-card.template-dark {
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 16px;
        }

        .quote-card.template-dark p:first-of-type {
            color: #f8fafc !important;
        }

        .quote-card.template-dark p:last-of-type {
            color: #94a3b8 !important;
        }

        .quote-card.template-dark i {
            color: #6366f1 !important;
            opacity: 0.5;
        }

        .quote-card.template-gradient {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.3);
        }

        .quote-card.template-gradient p {
            color: #ffffff !important;
        }

        .quote-card.template-gradient i {
            color: #ffffff !important;
            opacity: 0.3;
        }

        .quote-card.template-minimal {
            background: #f8fafc;
            border: none;
            border-left: 4px solid #6366f1;
            border-radius: 4px 16px 16px 4px;
        }

        .quote-card.template-minimal i {
            display: none;
        }

        /* --- ANALYTICS DASHBOARD CSS --- */
        .analytics-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .analytics-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .analytics-modal {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%;
            max-width: 700px;
            border-radius: 40px;
            padding: 48px;
            box-shadow: 0 50px 100px -20px rgba(15, 23, 42, 0.25);
            transform: scale(0.9) translateY(20px);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .active .analytics-modal {
            transform: scale(1) translateY(0);
        }

        .metric-pill {
            background: white;
            border: 1px solid #f1f5f9;
            padding: 24px;
            border-radius: 24px;
            transition: all 0.3s ease;
        }

        .metric-pill:hover {
            border-color: #6366f1;
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(99, 102, 241, 0.1);
        }
    </style>
</head>

<body
    class="bg-white text-slate-900 h-screen flex flex-col overflow-hidden antialiased selection:bg-indigo-50 selection:text-indigo-600 relative">
    <!-- Slash Command Menu -->
    <input type="file" id="global-image-upload" class="hidden" accept="image/*"
        onchange="handleGlobalImageUpload(this.files)">

    <div id="slashMenu" class="slash-menu">
        <div class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50/50">Core
            Elements</div>
        <div onclick="insertCreatedBlock('text')" class="slash-menu-item">
            <i data-lucide="type"></i>
            <div>
                <p class="text-xs font-semibold">Text Content</p>
                <p class="text-[10px] text-slate-400">Standard explanation block</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('heading')" class="slash-menu-item">
            <i data-lucide="heading"></i>
            <div>
                <p class="text-xs font-semibold">Heading</p>
                <p class="text-[10px] text-slate-400">Section title</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('code')" class="slash-menu-item">
            <i data-lucide="code"></i>
            <div>
                <p class="text-xs font-semibold">Code Snippet</p>
                <p class="text-[10px] text-slate-400">Interactive code editor</p>
            </div>
        </div>

        <div
            class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50/50 border-t border-slate-100">
            Interactive Cards</div>
        <div onclick="insertCreatedBlock('flipcards')" class="slash-menu-item">
            <i data-lucide="layers"></i>
            <div>
                <p class="text-xs font-semibold">3D Flipcards</p>
                <p class="text-[10px] text-slate-400">Self-quizzing multi-shape sets</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('expandable')" class="slash-menu-item">
            <i data-lucide="maximize"></i>
            <div>
                <p class="text-xs font-semibold">Expandable Cards</p>
                <p class="text-[10px] text-slate-400">Vertical/Horizontal reveal</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('gallery')" class="slash-menu-item">
            <i data-lucide="layout-grid"></i>
            <div>
                <p class="text-xs font-semibold">Quote Gallery</p>
                <p class="text-[10px] text-slate-400">Responsive grid of insights</p>
            </div>
        </div>

        <div
            class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50/50 border-t border-slate-100">
            Learning Activities</div>
        <div onclick="insertCreatedBlock('sorting')" class="slash-menu-item">
            <i data-lucide="mouse-pointer-2"></i>
            <div>
                <p class="text-xs font-semibold">D&D Categorization</p>
                <p class="text-[10px] text-slate-400">Sort items into buckets</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('sequence')" class="slash-menu-item">
            <i data-lucide="list-ordered"></i>
            <div>
                <p class="text-xs font-semibold">Sequence Builder</p>
                <p class="text-[10px] text-slate-400">Reorder steps logically</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('hotspots')" class="slash-menu-item">
            <i data-lucide="target"></i>
            <div>
                <p class="text-xs font-semibold">Spot the Error</p>
                <p class="text-[10px] text-slate-400">Interactive image hotspots</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('cloze')" class="slash-menu-item">
            <i data-lucide="text-cursor-input"></i>
            <div>
                <p class="text-xs font-semibold">Fill in the Blanks</p>
                <p class="text-[10px] text-slate-400">Cloze testing for recall</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('decision')" class="slash-menu-item">
            <i data-lucide="message-square-quote"></i>
            <div>
                <p class="text-xs font-semibold">Scenario Decision</p>
                <p class="text-[10px] text-slate-400">Critical thinking & Ethics</p>
            </div>
        </div>

        <div
            class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider bg-slate-50/50 border-t border-slate-100">
            Data & Logic</div>
        <div onclick="insertCreatedBlock('chart')" class="slash-menu-item">
            <i data-lucide="bar-chart-3"></i>
            <div>
                <p class="text-xs font-semibold">Bar Chart Explorer</p>
                <p class="text-[10px] text-slate-400">Hover metrics with tooltips</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('video')" class="slash-menu-item">
            <i data-lucide="video"></i>
            <div>
                <p class="text-xs font-semibold">Video Player</p>
                <p class="text-[10px] text-slate-400">Embed educational media</p>
            </div>
        </div>
        <div onclick="insertCreatedBlock('branching')" class="slash-menu-item">
            <i data-lucide="git-branch"></i>
            <div>
                <p class="text-xs font-semibold">Scenario Branching</p>
                <p class="text-[10px] text-slate-400">Choose-your-own-adventure</p>
            </div>
        </div>

        <div
            class="px-3 py-2 text-[10px] font-bold text-indigo-400 uppercase tracking-wider bg-indigo-50/50 border-t border-slate-100">
            Smart Resources</div>
        <div onclick="insertCreatedBlock('upload')" class="slash-menu-item">
            <i data-lucide="upload-cloud" class="text-indigo-600"></i>
            <div>
                <p class="text-xs font-semibold">Smart File Upload</p>
                <p class="text-[10px] text-slate-400">Turn files into activities</p>
            </div>
        </div>
    </div>

    <!-- TOP NAVIGATION -->
    <header class="h-14 border-b border-slate-200 flex items-center justify-between px-5 bg-white shrink-0 z-20">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-indigo-600">
                <i data-lucide="book-open" class="w-5 h-5"></i>
                <span class="font-semibold tracking-tight text-lg text-slate-900">Praband</span>
            </div>
            <div class="h-5 w-px bg-slate-200 mx-1"></div>
            <nav class="flex items-center gap-2 text-sm text-slate-500">
                <span class="hover:text-slate-900 cursor-pointer transition-colors">Workspace</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                <span class="hover:text-slate-900 cursor-pointer transition-colors">Data Structure</span>
                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                <span class="text-slate-900 font-medium">Module 1: Basics</span>
            </nav>
            <span class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full font-medium ml-2">Draft</span>
        </div>

        <div class="flex items-center gap-6">
            <!-- Device Toggle Group -->
            <div class="flex bg-slate-100 p-1 rounded-lg">
                <button onclick="setDeviceMode('tablet')" id="dev-tablet"
                    class="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-slate-600 transition-all"
                    title="Tablet Preview">
                    <i data-lucide="tablet" class="w-4 h-4"></i>
                </button>
                <button onclick="setDeviceMode('mobile')" id="dev-mobile"
                    class="w-8 h-8 flex items-center justify-center rounded-md text-slate-400 hover:text-slate-600 transition-all"
                    title="Mobile Preview">
                    <i data-lucide="smartphone" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="h-6 w-px bg-slate-200"></div>

            <div
                class="flex items-center gap-2 px-3 py-1.5 text-slate-500 hover:text-slate-900 text-sm font-medium cursor-pointer transition-colors">
                <i data-lucide="eye" class="w-4 h-4"></i>
                <span>Preview Lesson</span>
            </div>
            <button onclick="showAnalyticsDashboard()"
                class="bg-slate-900 hover:bg-slate-800 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors shadow-sm flex items-center gap-2">
                <span>Publish Changes</span>
            </button>
            <div
                class="w-8 h-8 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-500 ml-2">
                <span class="text-xs font-medium">DP</span>
            </div>
        </div>
    </header>

    <!-- MAIN WORKSPACE -->
    <div class="flex flex-1 overflow-hidden">

        <!-- LEFT PANEL: LESSON STRUCTURE -->
        <aside id="leftSidebar" class="sidebar w-72 border-r border-slate-200 bg-slate-50/50 flex flex-col shrink-0"
            style="width: 288px;">
            <!-- Resize Handle -->
            <div class="resize-handle resize-handle-left"></div>

            <!-- Toggle Button -->
            <div class="sidebar-toggle sidebar-toggle-left" onclick="toggleSidebar('left')">
                <i data-lucide="chevron-left" class="w-4 h-4 text-slate-400"></i>
            </div>

            <div class="sidebar-content">
                <div
                    class="p-4 border-b border-slate-200/60 flex items-center justify-between bg-white/50 backdrop-blur-sm sticky top-0 z-20">
                    <div class="flex items-center gap-2">
                        <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Course Curriculum</h2>
                        <button onclick="deselectBlock()" class="p-1 hover:bg-slate-200 rounded transition-colors"
                            title="Global Theme Studio">
                            <i data-lucide="palette" class="w-3 h-3 text-slate-400"></i>
                        </button>
                    </div>
                    <button onclick="addNewModule()"
                        class="w-7 h-7 flex items-center justify-center rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm transition-all"
                        title="Add New Module">
                        <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                    </button>
                </div>

                <div id="lessonFlowContent" class="flex-1 overflow-y-auto p-2 space-y-4"
                    ondragover="handleDragOver(event)">
                    <!-- Module 1 -->
                    <div class="module-group" id="module-1" draggable="true" ondragstart="handleDragStart(event)"
                        ondragend="handleDragEnd(event)">
                        <div class="module-header group" onclick="toggleModule(this)">
                            <div class="flex items-center gap-2">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3.5 h-3.5"></i></div>
                                <span class="module-title">1. Basics Introduction</span>
                            </div>
                            <i data-lucide="chevron-down"
                                class="w-3.5 h-3.5 text-slate-400 group-hover:text-slate-600 transition-transform"></i>
                        </div>

                        <div class="module-lessons mt-1 space-y-0.5" ondragover="handleDragOver(event)">
                            <div class="lesson-item-new group" draggable="true" ondragstart="handleDragStart(event)"
                                ondragend="handleDragEnd(event)">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3 h-3"></i></div>
                                <div class="lesson-status">
                                    <i data-lucide="check" class="w-2.5 h-2.5"></i>
                                </div>
                                <div class="lesson-info">
                                    <span class="lesson-name">AVL Tree</span>
                                    <span class="lesson-meta">Video • 12min</span>
                                </div>
                                <button class="delete-btn text-slate-300 hover:text-red-500 p-1"
                                    onclick="this.closest('.lesson-item-new').remove()">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>

                            <div class="lesson-item-new group bg-indigo-50/50 border-indigo-100 border" draggable="true"
                                ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3 h-3"></i></div>
                                <div class="lesson-status">
                                    <i data-lucide="check" class="w-2.5 h-2.5"></i>
                                </div>
                                <div class="lesson-info">
                                    <span class="lesson-name">Array</span>
                                    <span class="lesson-meta">Video • 18min</span>
                                </div>
                                <div
                                    class="absolute -left-1 top-1/2 -translate-y-1/2 w-1 h-6 bg-indigo-600 rounded-full">
                                </div>
                                <button class="delete-btn text-slate-300 hover:text-red-500 p-1"
                                    onclick="this.closest('.lesson-item-new').remove()">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>

                            <div class="lesson-item-new group">
                                <div class="lesson-status">
                                    <i data-lucide="check" class="w-2.5 h-2.5"></i>
                                </div>
                                <div class="lesson-info">
                                    <span class="lesson-name">Assignment One</span>
                                    <span class="lesson-meta">Assignment • 10 Questions</span>
                                </div>
                                <button class="delete-btn text-slate-300 hover:text-red-500 p-1"
                                    onclick="this.closest('.lesson-item-new').remove()">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Module 2 -->
                    <div class="module-group" id="module-2" draggable="true" ondragstart="handleDragStart(event)"
                        ondragend="handleDragEnd(event)">
                        <div class="module-header group" onclick="toggleModule(this)">
                            <div class="flex items-center gap-2">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3.5 h-3.5"></i></div>
                                <span class="module-title">2. Array</span>
                            </div>
                            <i data-lucide="chevron-down"
                                class="w-3.5 h-3.5 text-slate-400 group-hover:text-slate-600 transition-transform"></i>
                        </div>
                        <div class="module-lessons mt-1 space-y-0.5" ondragover="handleDragOver(event)">
                            <div class="lesson-item-new group" draggable="true" ondragstart="handleDragStart(event)"
                                ondragend="handleDragEnd(event)">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3 h-3"></i></div>
                                <div class="lesson-status border-2 border-slate-200 bg-transparent text-slate-200">
                                </div>
                                <div class="lesson-info">
                                    <span class="lesson-name">Array Creation</span>
                                    <span class="lesson-meta">Video • 25min</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="addNewContentBlock()"
                        class="w-full py-2.5 border border-dashed border-slate-300 rounded-lg text-xs font-semibold text-slate-600 hover:text-indigo-600 hover:border-indigo-300 hover:bg-indigo-50/50 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        Add Lesson to Module
                    </button>
                </div>
            </div>
        </aside>

        <!-- CENTER PANEL: CONTENT EDITOR -->
        <main id="editorMain" class="flex-1 overflow-y-auto bg-white relative transition-all duration-500">
            <div id="simulatorContainer"
                class="w-full min-h-full flex items-start justify-center py-12 transition-all duration-500">
                <div id="simulatorFrame"
                    class="w-full max-w-3xl bg-white min-h-[500px] py-12 px-8 transition-all duration-500 relative">
                    <!-- Home Indicator for mobile mode -->
                    <div id="mobile-home"
                        class="absolute bottom-2 left-1/2 -translate-x-1/2 w-32 h-1 bg-slate-200 rounded-full hidden">
                    </div>

                    <!-- Page Title -->
                    <div class="mb-10 group relative">
                        <input type="text" value="Data Structure And Algorithm Basics"
                            class="w-full text-3xl font-semibold tracking-tight text-slate-900 border-none focus:ring-0 p-0 placeholder-slate-300 bg-transparent">
                        <div class="flex items-center gap-4 mt-3 text-sm text-slate-400">
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3.5 h-3.5"></i> 25
                                mins</span>
                            <span class="flex items-center gap-1"><i data-lucide="user" class="w-3.5 h-3.5"></i>
                                Divyansh
                                Singh Parihar</span>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="space-y-8">

                        <!-- Text Block -->
                        <div onmousedown="selectBlock(this, 'text')"
                            class="content-block group relative rounded-xl hover:bg-slate-50 -mx-4 p-4 transition-colors border border-transparent hover:border-slate-100 cursor-pointer">
                            <div
                                class="absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                <button
                                    class="p-1.5 text-slate-400 hover:text-indigo-600 rounded bg-white shadow-sm border border-slate-200"><i
                                        data-lucide="edit-3" class="w-3.5 h-3.5"></i></button>
                                <button
                                    class="p-1.5 text-slate-400 hover:text-red-600 rounded bg-white shadow-sm border border-slate-200"><i
                                        data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                            <h3 contenteditable="true" class="text-lg font-medium text-slate-900 mb-2">Core Data
                                Structures
                                & Algorithms</h3>
                            <p contenteditable="true" class="text-base text-slate-600 leading-relaxed">
                                Efficiency in software engineering comes from choosing the right tool for the job. We
                                will
                                examine linear and non-linear data structures, focusing on memory layout and traversal
                                complexity.
                            </p>
                        </div>

                        <!-- AI Suggestion Trigger -->
                        <div class="flex items-center gap-3 my-2 cursor-pointer group">
                            <div class="h-px bg-indigo-100 flex-1 group-hover:bg-indigo-200 transition-colors"></div>
                            <div
                                class="flex items-center gap-1.5 text-xs font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100 shadow-sm group-hover:bg-indigo-100 transition-colors">
                                <i data-lucide="sparkles" class="w-3 h-3"></i>
                                AI Suggestion: Add Checkpoint Here
                            </div>
                            <div class="h-px bg-indigo-100 flex-1 group-hover:bg-indigo-200 transition-colors"></div>
                        </div>

                        <!-- Code Block (Selected State) -->
                        <div onmousedown="selectBlock(this, 'code')"
                            class="content-block relative group ring-offset-2 rounded-xl cursor-pointer">
                            <div
                                class="active-indicator absolute -right-3 top-4 translate-x-full hidden items-center gap-2">
                                <div
                                    class="bg-indigo-600 text-white text-xs font-medium px-2 py-1 rounded-md shadow-sm arrow-left">
                                    Active
                                </div>
                            </div>

                            <div
                                class="bg-slate-900 rounded-xl p-6 font-mono text-sm overflow-hidden text-slate-300 shadow-sm transition-all border-2 border-transparent">
                                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                    <span class="text-slate-400 text-xs uppercase tracking-wider">Binary Tree Node
                                        Structure</span>
                                    <span class="text-xs text-slate-500">JavaScript</span>
                                </div>
                                <pre><code><span class="text-purple-400">class</span> <span class="text-yellow-200">TreeNode</span> {
  <span class="text-blue-400">constructor</span>(value) {
    <span class="text-purple-400">this</span>.value = value;
    <span class="text-purple-400">this</span>.left = <span class="text-purple-400">null</span>;
    <span class="text-purple-400">this</span>.right = <span class="text-purple-400">null</span>;
  }
}</code></pre>
                            </div>

                            <!-- Inline Interaction Placeholder -->
                            <div
                                class="mt-4 border-2 border-dashed border-indigo-200 bg-indigo-50/30 rounded-lg p-3 flex items-center justify-between group-hover:border-indigo-300 transition-colors cursor-pointer">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                                        <i data-lucide="zap" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-slate-900">Interaction: Predict Output</p>
                                        <p class="text-xs text-slate-500">Difficulty: Medium • AI Generated</p>
                                    </div>
                                </div>
                                <button
                                    class="text-xs font-medium text-indigo-600 hover:text-indigo-700 bg-white border border-indigo-200 px-3 py-1.5 rounded-md shadow-sm">
                                    Configure
                                </button>
                            </div>
                        </div>

                        <!-- Text Block (AVL Trees) -->
                        <div onmousedown="selectBlock(this, 'text')"
                            class="content-block group relative rounded-xl hover:bg-slate-50 -mx-4 p-4 transition-colors border border-transparent hover:border-slate-100 cursor-pointer">
                            <h3 contenteditable="true" class="text-lg font-medium text-slate-900 mb-2">3. AVL Trees
                                (Self-Balancing)</h3>
                            <p contenteditable="true" class="text-base text-slate-600 leading-relaxed">
                                An <strong class="font-medium text-slate-900">AVL Tree</strong> is a self-balancing
                                Binary
                                Search Tree. It checks the height difference between left and right subtrees. If the
                                difference > 1, it performs a Rotation to rebalance.
                            </p>
                            <ul class="list-disc list-inside mt-3 text-base text-slate-600 space-y-1">
                                <li contenteditable="true"><strong class="font-medium text-slate-900">Worst Case
                                        Search:</strong> O(log n) - Much
                                    better than a skewed BST.</li>
                                <li contenteditable="true"><strong
                                        class="font-medium text-slate-900">Rotations:</strong>
                                    Left-Left, Right-Right,
                                    Left-Right, Right-Left.</li>
                            </ul>
                        </div>

                        <!-- Interactive Insert Trigger -->
                        <div id="editor-trigger" contenteditable="true" oninput="handleEditorInput(event)"
                            onkeydown="handleEditorKeyDown(event)"
                            class="min-h-[96px] flex items-center justify-center rounded-xl border border-dashed border-slate-200 text-slate-400 hover:text-slate-500 hover:border-slate-300 hover:bg-slate-50 transition-all cursor-text gap-2 outline-none focus:border-indigo-300 focus:bg-indigo-50/30">
                            <i data-lucide="plus" class="w-5 h-5 pointer-events-none"></i>
                            <span class="font-medium pointer-events-none">Press 'Ctrl + /' to insert content</span>
                        </div>

                    </div>
                </div>
        </main>

        <!-- RIGHT PANEL: INTERACTION & AI TOOLS -->
        <aside id="rightSidebar" class="sidebar w-80 border-l border-slate-200 bg-white flex flex-col shrink-0"
            style="width: 320px;">
            <!-- Resize Handle -->
            <div class="resize-handle resize-handle-right"></div>

            <!-- Toggle Button -->
            <div class="sidebar-toggle sidebar-toggle-right" onclick="toggleSidebar('right')">
                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
            </div>

            <div id="dynamicSidebarContent" class="sidebar-content flex flex-col h-full">
                <!-- Neutral / Empty State -->
                <div class="flex-1 flex flex-col items-center justify-center p-8 text-center bg-slate-50/30">
                    <div
                        class="w-20 h-20 bg-white shadow-sm border border-slate-100 rounded-3xl flex items-center justify-center mb-6 animate-pulse">
                        <i data-lucide="layout" class="w-10 h-10 text-slate-200"></i>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 mb-2">Ready to Design</h3>
                    <p class="text-xs text-slate-500 leading-relaxed">Select any content block in the workspace to open
                        the intelligent inspector and AI authoring tools.</p>

                    <div class="mt-8 pt-8 border-t border-slate-100 w-full">
                        <div
                            class="flex items-center gap-2 justify-center text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            <i data-lucide="keyboard" class="w-3 h-3"></i> Quick Tip
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2">Press <kbd
                                class="px-1.5 py-0.5 bg-white border border-slate-200 rounded shadow-sm">Ctrl + /</kbd>
                            to insert new interactive components.</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        function showAnalyticsDashboard() {
            const sidebar = document.getElementById('dynamicSidebarContent');
            if (!sidebar) return;

            // Highlight the fact that we are in Publish Report mode
            sidebar.innerHTML = `
                <div class="p-4 border-b border-slate-100 bg-emerald-50 sticky top-0 z-20">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[10px] font-black text-emerald-600 uppercase tracking-widest">Publish Report</span>
                    </div>
                    <p class="text-sm font-bold text-slate-900">Deployment Prediction</p>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth bg-white">
                    <!-- Top Performance Insight -->
                    <div class="p-5 bg-indigo-600 rounded-2xl text-white relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:rotate-12 transition-transform">
                            <i data-lucide="trending-up" class="w-20 h-20"></i>
                        </div>
                        <p class="text-[9px] font-black uppercase tracking-widest opacity-60 mb-3">AI Prediction</p>
                        <p class="text-sm font-bold leading-snug mb-4">Students will spend <span class="text-emerald-300">2.4× longer</span> on Story Blocks</p>
                        <div class="h-1 w-full bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-400 w-[85%]"></div>
                        </div>
                    </div>

                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-100 rounded-xl">
                            <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter mb-1">Interactions</p>
                            <p class="text-xl font-bold text-slate-900">68%</p>
                            <p class="text-[8px] text-indigo-500 font-bold">+12% vs Avg</p>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-100 rounded-xl">
                            <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter mb-1">Retention</p>
                            <p class="text-xl font-bold text-slate-900">92%</p>
                            <p class="text-[8px] text-emerald-500 font-bold">Optimal</p>
                        </div>
                    </div>

                    <!-- CRITICAL: Component Recommendations -->
                    <div class="pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                            <h4 class="text-xs font-black text-slate-900 uppercase tracking-widest">Boost Engagement Further</h4>
                        </div>
                        
                        <div class="space-y-3">
                            <div onclick="addFromRecommendation('decision')" class="group p-3 border border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-[10px] font-bold text-slate-700 group-hover:text-indigo-600 flex items-center gap-2">
                                        <i data-lucide="message-square-quote" class="w-3 h-3 text-indigo-500"></i>
                                        Scenario Decision
                                    </span>
                                    <i data-lucide="plus" class="w-3 h-3 text-slate-300 group-hover:text-indigo-600 transition-transform"></i>
                                </div>
                                <p class="text-[9px] text-slate-500 leading-tight">Add a critical dilemma here to boost thinking depth by <span class="font-bold text-indigo-600">40%</span>.</p>
                            </div>

                            <div onclick="addFromRecommendation('hotspots')" class="group p-3 border border-slate-100 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-[10px] font-bold text-slate-700 group-hover:text-indigo-600 flex items-center gap-2">
                                        <i data-lucide="target" class="w-3 h-3 text-emerald-500"></i>
                                        Spot the Error
                                    </span>
                                    <i data-lucide="plus" class="w-3 h-3 text-slate-300 group-hover:text-indigo-600"></i>
                                </div>
                                <p class="text-[9px] text-slate-500 leading-tight">Convert dense diagrams into hotspots to reduce cognitive drop-off.</p>
                            </div>

                            <div class="p-3 bg-slate-900 rounded-xl text-white">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="zap" class="w-3 h-3 text-amber-400"></i>
                                    <span class="text-[10px] font-bold">Pro Tip: Cloze Recaps</span>
                                </div>
                                <p class="text-[9px] text-slate-400 leading-tight">Lessons with a cumulative <b>Cloze Recap</b> see 3x higher assignment pass rates.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="renderWorkspaceDefault()" class="w-full py-2.5 text-xs font-bold text-indigo-600 hover:bg-white rounded-lg transition-colors border border-indigo-100 shadow-sm">
                        Continue Editing
                    </button>
                </div>
            `;

            // Open sidebar if it was collapsed
            const rightSidebar = document.getElementById('rightSidebar');
            if (rightSidebar.classList.contains('collapsed')) {
                toggleSidebar('right');
            }

            lucide.createIcons();
        }
        lucide.createIcons();

        // SIDEBAR MANAGEMENT
        function toggleSidebar(side) {
            const sidebar = document.getElementById(side === 'left' ? 'leftSidebar' : 'rightSidebar');
            const toggle = sidebar.querySelector('.sidebar-toggle');
            const isCollapsed = sidebar.classList.toggle('collapsed');

            // Update toggle button position and icon
            if (isCollapsed) {
                toggle.classList.add('collapsed-state');
                toggle.innerHTML = `<i data-lucide="${side === 'left' ? 'chevron-right' : 'chevron-left'}" class="w-4 h-4 text-indigo-600"></i>`;
            } else {
                toggle.classList.remove('collapsed-state');
                toggle.innerHTML = `<i data-lucide="${side === 'left' ? 'chevron-left' : 'chevron-right'}" class="w-4 h-4 text-slate-400"></i>`;
            }
            lucide.createIcons();
        }

        // RESIZE FUNCTIONALITY
        function initResize(side) {
            const sidebar = document.getElementById(side === 'left' ? 'leftSidebar' : 'rightSidebar');
            const handle = sidebar.querySelector(`.resize-handle-${side}`);
            let isResizing = false;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                handle.classList.add('active');
                document.body.classList.add('is-resizing');

                // Disable transitions during resize
                sidebar.style.transition = 'none';

                // Add temporary overlay to prevent iframe/interaction issues if any
                const overlay = document.createElement('div');
                overlay.id = 'resize-overlay';
                overlay.style.fixed = 'position: fixed; inset: 0; z-index: 9999; cursor: col-resize;';
                document.body.appendChild(overlay);
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                let newWidth;
                if (side === 'left') {
                    newWidth = e.clientX;
                } else {
                    newWidth = window.innerWidth - e.clientX;
                }

                // Constraint checks (min 200, max 600)
                if (newWidth >= 200 && newWidth <= 600) {
                    sidebar.style.width = `${newWidth}px`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    handle.classList.remove('active');
                    document.body.classList.remove('is-resizing');

                    const overlay = document.getElementById('resize-overlay');
                    if (overlay) overlay.remove();

                    // Re-enable transitions
                    sidebar.style.transition = 'width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease';
                }
            });
        }

        initResize('left');
        initResize('right');

        // --- STATE MANAGEMENT & PERSISTENCE ---
        let courseData = {
            modules: [
                {
                    id: 'mod-1',
                    title: '1. Basics Introduction',
                    lessons: [
                        { id: 'les-1', title: 'AVL Tree', meta: 'Video • 12min', type: 'video' },
                        { id: 'les-2', title: 'Array', meta: 'Video • 18min', type: 'video', active: true },
                        { id: 'les-3', title: 'Assignment One', meta: 'Assignment • 10 Questions', type: 'assignment' }
                    ]
                },
                {
                    id: 'mod-2',
                    title: '2. Array',
                    lessons: [
                        { id: 'les-4', title: 'Array Creation', meta: 'Video • 25min', type: 'video' }
                    ]
                }
            ]
        };

        function saveState() {
            localStorage.setItem('praband_course_data', JSON.stringify(courseData));
            console.log('State saved');
        }

        function loadState() {
            const saved = localStorage.getItem('praband_course_data');
            if (saved) {
                courseData = JSON.parse(saved);
                renderSidebar();
            }
        }

        // --- SIDEBAR RENDERING ---
        function renderSidebar() {
            const container = document.getElementById('lessonFlowContent');
            container.innerHTML = '';

            courseData.modules.forEach((mod, modIdx) => {
                const moduleHtml = `
                    <div class="module-group" id="${mod.id}" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)">
                        <div class="module-header group" onclick="toggleModule(this)">
                            <div class="flex items-center gap-2">
                                <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3.5 h-3.5"></i></div>
                                <input type="text" value="${mod.title}" 
                                    onchange="updateModuleTitle('${mod.id}', this.value)"
                                    onclick="event.stopPropagation()"
                                    class="module-title bg-transparent border-none focus:ring-0 p-0 w-full font-semibold">
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); deleteModule('${mod.id}')" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                </button>
                                <i data-lucide="chevron-down" class="w-3.5 h-3.5 text-slate-400 group-hover:text-slate-600 transition-transform"></i>
                            </div>
                        </div>
                        <div class="module-lessons mt-1 space-y-0.5" ondragover="handleDragOver(event)">
                            ${mod.lessons.map(les => `
                                <div class="lesson-item-new group ${les.active ? 'bg-indigo-50/50 border-indigo-100 border' : ''}" 
                                     draggable="true" 
                                     onclick="selectLesson('${les.id}')"
                                     ondragstart="handleDragStart(event)" 
                                     ondragend="handleDragEnd(event)"
                                     id="${les.id}">
                                    <div class="drag-handle"><i data-lucide="grip-vertical" class="w-3 h-3"></i></div>
                                    <div class="lesson-status ${les.type === 'assignment' ? 'border-2 border-slate-200 bg-transparent text-slate-200' : ''}">
                                        ${les.type !== 'assignment' ? '<i data-lucide="check" class="w-2.5 h-2.5"></i>' : ''}
                                    </div>
                                    <div class="lesson-info">
                                        <input type="text" value="${les.title}" 
                                            onchange="updateLessonTitle('${les.id}', this.value)"
                                            onclick="event.stopPropagation()"
                                            class="lesson-name bg-transparent border-none focus:ring-0 p-0 w-full text-sm font-medium">
                                        <span class="lesson-meta">${les.meta}</span>
                                    </div>
                                    ${les.active ? '<div class="absolute -left-1 top-1/2 -translate-y-1/2 w-1 h-6 bg-indigo-600 rounded-full"></div>' : ''}
                                    <button class="delete-btn text-slate-300 hover:text-red-500 p-1" onclick="event.stopPropagation(); deleteLesson('${les.id}')">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', moduleHtml);
            });
            lucide.createIcons();
        }

        // --- LESSON ACTIONS ---
        function selectLesson(lessonId) {
            // Update state
            courseData.modules.forEach(m => m.lessons.forEach(l => {
                l.active = (l.id === lessonId);
            }));

            // Re-render sidebar and editor
            renderSidebar();
            renderEditor(lessonId);
            saveState();
        }

        function renderEditor(lessonId) {
            let selectedLesson = null;
            courseData.modules.forEach(m => {
                const found = m.lessons.find(l => l.id === lessonId);
                if (found) selectedLesson = found;
            });

            if (!selectedLesson) return;

            // Update Page Title
            const titleInput = document.querySelector('main input[type="text"]');
            if (titleInput) titleInput.value = selectedLesson.title;

            // In a real app, we'd load the content blocks here.
            // For now, we'll just show it works by updating the title.
            console.log('Rendering editor for:', selectedLesson.title);
        }

        function updateLessonTitle(id, newTitle) {
            courseData.modules.forEach(m => {
                const les = m.lessons.find(l => l.id === id);
                if (les) les.title = newTitle;
            });
            saveState();
        }

        function updateModuleTitle(id, newTitle) {
            const mod = courseData.modules.find(m => m.id === id);
            if (mod) mod.title = newTitle;
            saveState();
        }

        function deleteLesson(id) {
            courseData.modules.forEach(m => {
                m.lessons = m.lessons.filter(l => l.id !== id);
            });
            renderSidebar();
            saveState();
        }

        function deleteModule(id) {
            courseData.modules = courseData.modules.filter(m => m.id !== id);
            renderSidebar();
            saveState();
        }

        function addNewModule() {
            const id = 'mod-' + Date.now();
            courseData.modules.push({
                id: id,
                title: (courseData.modules.length + 1) + '. New Module',
                lessons: []
            });
            renderSidebar();
            saveState();

            // Scroll to bottom
            const container = document.getElementById('lessonFlowContent');
            container.scrollTop = container.scrollHeight;
        }

        function addNewContentBlock() {
            let lastModule = courseData.modules[courseData.modules.length - 1];
            if (!lastModule) {
                addNewModule();
                lastModule = courseData.modules[courseData.modules.length - 1];
            }

            const id = 'les-' + Date.now();
            lastModule.lessons.push({
                id: id,
                title: 'New Lesson',
                meta: 'Draft • duration',
                type: 'video'
            });

            renderSidebar();
            selectLesson(id);
            saveState();
        }

        // --- UI UTILS ---
        function toggleModule(header) {
            const group = header.closest('.module-group');
            group.classList.toggle('collapsed');
        }

        // --- DRAG AND DROP ---
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = e.currentTarget;
            e.stopPropagation();
            setTimeout(() => e.target.classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');

            // Sync state after drop
            syncStateFromDOM();
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();

            const container = e.currentTarget;
            const isDraggingModule = draggedElement.classList.contains('module-group');
            const isDraggingLesson = draggedElement.classList.contains('lesson-item-new');

            if (isDraggingModule && container.id === 'lessonFlowContent') {
                const afterElement = getDragAfterElement(container, e.clientY, '.module-group');
                if (afterElement == null) container.appendChild(draggedElement);
                else container.insertBefore(draggedElement, afterElement);
            } else if (isDraggingLesson && container.classList.contains('module-lessons')) {
                const afterElement = getDragAfterElement(container, e.clientY, '.lesson-item-new');
                if (afterElement == null) container.appendChild(draggedElement);
                else container.insertBefore(draggedElement, afterElement);
            }
        }

        // --- INTERACTION LOGIC ---
        function toggleFlip(card) {
            card.classList.toggle('flipped');
        }

        function toggleExpand(el, type) {
            el.classList.toggle('expanded');
            if (el.classList.contains('expanded')) {
                el.querySelector('.expand-icon').style.transform = type === 'vertical' ? 'rotate(180deg)' : 'rotate(90deg)';
            } else {
                el.querySelector('.expand-icon').style.transform = 'rotate(0deg)';
            }
        }

        function handleHotspot(el, isCorrect) {
            const feedback = el.closest('.content-block').querySelector('.hotspot-feedback');
            feedback.innerHTML = isCorrect ?
                '<span class="text-green-600 font-bold uppercase text-[10px]">CORRECT!</span> That is the intentional error.' :
                '<span class="text-red-500 font-bold uppercase text-[10px]">INCORRECT.</span> Keep looking for the structural error.';
        }

        function handleScenario(btn, nodeId) {
            const container = btn.closest('.scenario-container');
            const nodes = {
                'start': { text: 'You find a bug in the code. Do you fix it or ignore it?', choices: [{ t: 'Fix it', n: 'fix' }, { t: 'Ignore', n: 'ignore' }] },
                'fix': { text: 'Great! The system is stable now. You gain 10 XP.', choices: [{ t: 'Reset', n: 'start' }] },
                'ignore': { text: 'The bug caused a crash! You lost 5 XP.', choices: [{ t: 'Reset', n: 'start' }] }
            };
            const node = nodes[nodeId] || nodes['start'];
            container.querySelector('.scenario-text').innerText = node.text;
            const btnBox = container.querySelector('.scenario-buttons');
            btnBox.innerHTML = node.choices.map(c => `
                <button onclick="handleScenario(this, '${c.n}')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-medium hover:bg-indigo-700 transition-colors">${c.t}</button>
            `).join('');
        }

        // --- SORTING INTERACTION LOGIC ---
        function handleDragStartSorting(e) {
            e.dataTransfer.setData('text', e.target.id);
        }

        function handleDragOverSorting(e) {
            e.preventDefault();
        }

        function handleDropSorting(e) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text');
            const el = document.getElementById(id);
            const accept = e.currentTarget.getAttribute('data-accept');

            if (el.getAttribute('data-type') === accept) {
                e.currentTarget.appendChild(el);
                el.classList.add('bg-green-100', 'border-green-300', 'text-green-700');
                el.classList.remove('bg-indigo-50', 'border-indigo-100', 'text-indigo-600');
            } else {
                el.classList.add('shake');
                setTimeout(() => el.classList.remove('shake'), 400);
            }
        }

        function handleDragStartSorting(e) { e.dataTransfer.setData('text', e.target.id); }
        function handleDragOverSorting(e) { e.preventDefault(); }
        function handleDropSorting(e, category) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text');
            const el = document.getElementById(id);
            const accept = e.currentTarget.getAttribute('data-accept');
            if (el.getAttribute('data-type') === accept) {
                e.currentTarget.appendChild(el);
                el.classList.add('bg-green-100', 'border-green-300');
                el.classList.remove('bg-indigo-50', 'border-indigo-100');
            } else {
                el.classList.add('shake');
                setTimeout(() => el.classList.remove('shake'), 500);
            }
        }

        // --- SYNTAX HIGHLIGHTING LOGIC ---
        function updateCodeTheme(select) {
            const container = select.closest('.content-block').querySelector('.bg-slate-900');
            container.classList.remove('theme-midnight', 'theme-forest');
            if (select.value !== 'theme-default') {
                container.classList.add(select.value);
            }
        }

        function highlightCode(element) {
            const container = element.closest('.content-block');
            const language = container.querySelector('.lang-selector').value;
            const text = element.innerText;

            const rules = {
                javascript: [
                    { regex: /\b(class|const|let|var|function|return|if|else|for|while|import|export|from|new|this|null|undefined|async|await)\b/g, class: 'text-purple-400' },
                    { regex: /(['"`])(.*?)\1/g, class: 'text-emerald-400' },
                    { regex: /\/\/.*/g, class: 'text-slate-500 italic' }
                ],
                python: [
                    { regex: /\b(def|class|return|if|else|elif|for|while|import|from|as|None|True|False|self|in|is|not|and|or)\b/g, class: 'text-purple-400' },
                    { regex: /(['"`])(.*?)\1/g, class: 'text-emerald-400' },
                    { regex: /#.*/g, class: 'text-slate-500 italic' }
                ]
            };

            const langRules = rules[language] || rules.javascript;
            let highlighted = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            langRules.forEach(rule => {
                highlighted = highlighted.replace(rule.regex, (match) => `<span class="${rule.class}">${match}</span>`);
            });

            // Save cursor position
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const offset = getCursorOffset(element, range.startContainer, range.startOffset);

                element.innerHTML = highlighted;

                // Restore cursor
                restoreCursorOffset(element, offset);
            } else {
                element.innerHTML = highlighted;
            }
        }

        function getCursorOffset(parent, node, offset) {
            let total = 0;
            const walk = document.createTreeWalker(parent, NodeFilter.SHOW_TEXT);
            while (walk.nextNode()) {
                if (walk.currentNode === node) return total + offset;
                total += walk.currentNode.textContent.length;
            }
            return total;
        }

        function restoreCursorOffset(parent, offset) {
            const walk = document.createTreeWalker(parent, NodeFilter.SHOW_TEXT);
            let total = 0;
            while (walk.nextNode()) {
                const len = walk.currentNode.textContent.length;
                if (total + len >= offset) {
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.setStart(walk.currentNode, offset - total);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    return;
                }
                total += len;
            }
        }

        function getDragAfterElement(container, y, selector) {
            const draggableElements = [...container.querySelectorAll(`${selector}:not(.dragging)`)];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function syncStateFromDOM() {
            const newModules = [];
            document.querySelectorAll('.module-group').forEach(modEl => {
                const modId = modEl.id;
                const existingMod = courseData.modules.find(m => m.id === modId);
                if (existingMod) {
                    const newLessons = [];
                    modEl.querySelectorAll('.lesson-item-new').forEach(lesEl => {
                        const lesId = lesEl.id;
                        // Find lesson in ANY module (it might have moved)
                        let foundLes = null;
                        courseData.modules.forEach(m => {
                            const l = m.lessons.find(ls => ls.id === lesId);
                            if (l) foundLes = l;
                        });
                        if (foundLes) newLessons.push(foundLes);
                    });
                    existingMod.lessons = newLessons;
                    newModules.push(existingMod);
                }
            });
            courseData.modules = newModules;
            saveState();
        }

        // --- CONTEXT SIDEBAR MANAGEMENT ---
        const contextInsights = {
            'text': {
                title: 'Selection: Text Block (Core Concepts)',
                insight: 'This section covers fundamental concepts. Adding a "Compare" interaction here can help students distinguish between Linear and Non-linear structures.',
                question: 'Which of the following best describes a Linear Data Structure?',
                answers: [
                    { text: 'Nodes are connected in a hierarchical way', correct: false },
                    { text: 'Elements are arranged in a sequential manner', correct: true },
                    { text: 'Data is stored in a multi-dimensional grid', correct: false }
                ]
            },
            'code': {
                title: 'Selection: Code Block (TreeNode)',
                insight: 'Students often confuse specific node instantiation. A "Predict Output" interaction here increases retention by 40%.',
                question: 'What will be the value of node.left immediately after instantiation?',
                answers: [
                    { text: 'undefined', correct: false },
                    { text: 'null', correct: true },
                    { text: '0', correct: false }
                ]
            },
            'flipcards': {
                title: 'Selection: 3D Flipcards',
                insight: '3D Flipcards are excellent for self-quizzing and long-term retention. Use them for definitions or "Before/After" comparisons.',
                question: 'Which CSS property allows the back face of an element to be hidden when rotated?',
                answers: [
                    { text: 'backface-visibility', correct: true },
                    { text: 'perspective', correct: false },
                    { text: 'transform-style', correct: false }
                ]
            },
            'expandable': {
                title: 'Selection: Expandable Content',
                insight: 'Progressive disclosure prevents cognitive overload. Use vertical expansion for long explanations and horizontal for quick definitions.',
                question: 'What is the primary benefit of "Progressive Disclosure"?',
                answers: [
                    { text: 'Faster page loading', correct: false },
                    { text: 'Reduced cognitive load', correct: true },
                    { text: 'Better image quality', correct: false }
                ]
            },
            'video': {
                title: 'Selection: Video Player',
                insight: 'Video is the most engaging medium. Pairing it with a "Live Transcript" helps with accessibility and allows students to search content.',
                question: 'What is the main benefit of adding a Live Transcript to videos?',
                answers: [
                    { text: 'Increases file size', correct: false },
                    { text: 'Improves accessibility & SEO', correct: true },
                    { text: 'Changes the video speed', correct: false }
                ]
            },
            'cloze': {
                title: 'Selection: Fill in the Blanks',
                insight: 'Cloze testing is powerful for language acquisition and factual recall. Ensure you provide clear context clues around the blanks.',
                question: 'How many blanks are optimal per paragraph for learning?',
                answers: [
                    { text: '1-3 blanks', correct: true },
                    { text: '5-8 blanks', correct: false },
                    { text: 'Every other word', correct: false }
                ]
            },
            'decision': {
                title: 'Selection: Scenario Decision',
                insight: 'Use this for subjective topics. It forces learners to justify their choices, which deepens critical thinking skills.',
                question: 'What is the "Dilemma Method" primarily used for?',
                answers: [
                    { text: 'Testing memory', correct: false },
                    { text: 'Applying knowledge to complex situations', correct: true },
                    { text: 'Fast-paced testing', correct: false }
                ]
            },
            'upload': {
                title: 'Selection: Smart Resource',
                insight: 'Converting files into active experiences increases time-on-lesson by 2.3x. Choose an intent that matches your learning objective.',
                question: 'Which intent is best for promoting critical decision-making?',
                answers: [
                    { text: 'Understand', correct: false },
                    { text: 'Apply', correct: true },
                    { text: 'Explore', correct: false }
                ]
            }
        };

        // Global monitor for selection
        let activeHotspotIndex = null;
        window.addEventListener('mousedown', (e) => {
            const block = e.target.closest('.content-block');
            if (block) {
                if (selectedBlockElement !== block) {
                    const type = block.getAttribute('data-type') || 'text';
                    activeHotspotIndex = null;
                    selectBlock(block, type);
                }
            } else if (!e.target.closest('.sidebar') && !e.target.closest('.slash-menu') && !e.target.closest('header')) {
                // Clicked workspace background
                deselectBlock();
            }
        });

        function deselectBlock() {
            selectedBlockElement = null;
            document.querySelectorAll('.content-block').forEach(block => {
                block.classList.remove('ring-2', 'ring-indigo-500/20');
                const indicator = block.querySelector('.active-indicator');
                if (indicator) indicator.classList.add('hidden');
                const codeContainer = block.querySelector('.bg-slate-900');
                if (codeContainer) codeContainer.style.borderColor = 'transparent';
            });
            renderWorkspaceDefault();
        }

        function selectBlock(element, type) {
            // Remove active state from all blocks
            document.querySelectorAll('.content-block').forEach(block => {
                block.classList.remove('ring-2', 'ring-indigo-500/20');
                const indicator = block.querySelector('.active-indicator');
                if (indicator) indicator.classList.add('hidden');

                // If it's a code block, remove the border highlight
                const codeContainer = block.querySelector('.bg-slate-900');
                if (codeContainer) codeContainer.style.borderColor = 'transparent';
            });

            // Add active state to selected block
            element.classList.add('ring-2', 'ring-indigo-500/20');
            const indicator = element.querySelector('.active-indicator');
            if (indicator) indicator.classList.remove('hidden');
            if (indicator) indicator.classList.add('flex');

            // If it's a code block, highlight the border
            const codeContainer = element.querySelector('.bg-slate-900');
            if (codeContainer) codeContainer.style.borderColor = '#6366f1';

            // Update Right Sidebar Context & Settings
            renderBlockSettings(element, type);
        }

        // --- COMPONENT SETTINGS SYSTEM ---
        let selectedBlockElement = null;

        function renderBlockSettings(element, type) {
            selectedBlockElement = element;
            const sidebar = document.getElementById('dynamicSidebarContent');
            if (!sidebar) return;

            // Header Section (Always show context at top)
            const context = contextInsights[type] || { title: 'Selection: Content Block', insight: 'View settings below.' };

            sidebar.innerHTML = `
                <div class="p-4 border-b border-slate-100 bg-white sticky top-0 z-20">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Context Inspector</span>
                    </div>
                    <p class="text-sm font-bold text-slate-900 truncate">${context.title}</p>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth">
                    <div id="block-settings-render-area"></div>
                </div>

                <div class="p-4 border-t border-slate-100 bg-slate-50/50">
                    <button onclick="selectedBlockElement.remove(); hideSidebarOnDelete()" class="w-full py-2.5 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center gap-2 border border-red-100">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Remove Block
                    </button>
                </div>
            `;

            const renderArea = document.getElementById('block-settings-render-area');

            switch (type) {
                case 'text':
                case 'heading':
                    renderTextSettings(renderArea);
                    break;
                case 'code':
                    renderCodeSettings(renderArea);
                    break;
                case 'flipcards':
                    renderFlipcardSettings(renderArea);
                    break;
                case 'chart':
                    renderChartSettings(renderArea);
                    break;
                case 'hotspots':
                    renderHotspotSettings(renderArea);
                    break;
                case 'quiz':
                    renderQuizSettings(renderArea);
                    break;
                case 'sequence':
                    renderSequenceSettings(renderArea);
                    break;
                case 'expandable':
                    renderExpandableSettings(renderArea);
                    break;
                case 'sorting':
                    renderSortingSettings(renderArea);
                    break;
                case 'branching':
                    renderBranchingSettings(renderArea);
                    break;
                case 'gallery':
                    renderGallerySettings(renderArea);
                    break;
                case 'video':
                    renderVideoSettings(renderArea);
                    break;
                case 'cloze':
                    renderClozeSettings(renderArea);
                    break;
                case 'decision':
                    renderDecisionSettings(renderArea);
                    break;
                case 'upload':
                    renderUploadSettings(renderArea);
                    break;
                default:
                    renderArea.innerHTML = '<p class="text-xs text-slate-400">Settings for this block type are under development.</p>';
            }
            lucide.createIcons();
        }

        // --- DYNAMIC REWARD & RECOMMENDATION SYSTEM ---
        let lessonPerformanceScore = 42;
        let completedRecommendations = [];
        const recommendationPool = [
            {
                id: 'decision',
                type: 'decision',
                title: 'Scenario Decision',
                icon: 'git-branch',
                color: 'indigo',
                benefit: '37%',
                desc: 'Increases critical thinking retention.',
                points: 12
            },
            {
                id: 'hotspots',
                type: 'hotspots',
                title: 'Spot the Error',
                icon: 'target',
                color: 'emerald',
                benefit: '25%',
                desc: 'Perfect for complex diagrams. Reduces overload.',
                points: 10
            },
            {
                id: 'cloze',
                type: 'cloze',
                title: 'Cloze Recap',
                icon: 'languages',
                color: 'amber',
                benefit: '3x',
                desc: 'Boosts pass rates via cumulative recall.',
                points: 15
            },
            {
                id: 'sequence',
                type: 'sequence',
                title: 'Sequence Builder',
                icon: 'list-ordered',
                color: 'rose',
                benefit: '18%',
                desc: 'Clarifies procedural steps for learners.',
                points: 8
            }
        ];

        function addFromRecommendation(recId) {
            const rec = recommendationPool.find(r => r.id === recId);
            if (!rec) return;

            // 1. Add the block
            insertCreatedBlock(rec.type);

            // 2. Update state
            completedRecommendations.push(recId);
            lessonPerformanceScore += rec.points;
            if (lessonPerformanceScore > 99) lessonPerformanceScore = 99;

            // 3. Briefly show a success state before the block settings take over
            const sidebar = document.getElementById('dynamicSidebarContent');
            sidebar.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center p-8 text-center animate-in zoom-in-95 duration-300">
                    <div class="w-20 h-20 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mb-6 shadow-inner">
                        <i data-lucide="check-circle-2" class="w-10 h-10"></i>
                    </div>
                    <h4 class="text-xl font-bold text-slate-900 mb-2">Strategy Applied!</h4>
                    <p class="text-sm text-slate-500">Pedagogical depth increased by ${rec.benefit}. Score updated to ${lessonPerformanceScore}%.</p>
                </div>
            `;
            lucide.createIcons();

            // Note: Since insertCreatedBlock calls selectBlock, the sidebar will 
            // automatically shift to the new block's settings after this brief moment.
            // When the user deselects, they will see the updated renderWorkspaceDefault.
        }

        function renderWorkspaceDefault() {
            const sidebar = document.getElementById('dynamicSidebarContent');
            if (!sidebar) return;

            const pending = recommendationPool.filter(r => !completedRecommendations.includes(r.id));
            const displayRecs = pending.slice(0, 2);

            sidebar.innerHTML = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 text-indigo-600"></i>
                        <span class="text-[10px] font-black text-slate-900 uppercase tracking-[0.2em]">Workspace Insights</span>
                    </div>
                    <p class="text-xs text-slate-500 leading-relaxed font-medium">Data-driven recommendations for your lesson.</p>
                </div>

                <div class="flex-1 overflow-y-auto p-5 space-y-8 bg-white">
                    <!-- Global Performance Prediction -->
                    <div class="p-6 bg-gradient-to-br from-slate-900 to-indigo-950 rounded-[2rem] text-white relative overflow-hidden shadow-xl">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl"></div>
                        <p class="text-[9px] font-black uppercase tracking-widest text-indigo-400 mb-4 opacity-80">Praband AI Prediction</p>
                        <h4 class="text-lg font-bold leading-tight mb-6">Your lesson performance is predicted to reach <span class="text-emerald-400">${lessonPerformanceScore}%</span>.</h4>
                        
                        <div class="space-y-4">
                            <div class="flex items-center justify-between text-[10px] font-bold">
                                <span class="opacity-60 uppercase">Target Retention</span>
                                <span class="text-indigo-300">High Impact</span>
                            </div>
                            <div class="h-1.5 w-full bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-emerald-400 transition-all duration-1000" style="width: ${lessonPerformanceScore}%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Suggested Next Steps -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i>
                            <h4 class="text-[10px] font-black text-slate-900 uppercase tracking-widest">Boost Engagement score</h4>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            ${displayRecs.length > 0 ? displayRecs.map(rec => `
                                <div onclick="addFromRecommendation('${rec.id}')" class="group p-4 border border-slate-100 rounded-2xl hover:border-${rec.color}-500 hover:bg-${rec.color}-50/50 transition-all cursor-pointer">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="w-8 h-8 bg-${rec.color}-50 text-${rec.color}-600 rounded-xl flex items-center justify-center group-hover:bg-${rec.color}-600 group-hover:text-white transition-all">
                                            <i data-lucide="${rec.icon}" class="w-4 h-4"></i>
                                        </div>
                                        <i data-lucide="plus" class="w-4 h-4 text-slate-200 group-hover:text-${rec.color}-400"></i>
                                    </div>
                                    <h5 class="text-xs font-bold text-slate-900 mb-1">${rec.title}</h5>
                                    <p class="text-[10px] text-slate-500 leading-relaxed font-medium">${rec.desc} <span class="text-${rec.color}-600 font-bold">+${rec.benefit}</span></p>
                                </div>
                            `).join('') : `
                                <div class="p-8 border-2 border-dashed border-slate-100 rounded-2xl text-center">
                                    <div class="w-12 h-12 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i data-lucide="trophy" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-xs font-bold text-slate-900">You are good to go!</p>
                                    <p class="text-[10px] text-slate-400 mt-1">Maximum pedagogical leverage achieved with current components.</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Themes Shortcut -->
                    <div class="pt-6 border-t border-slate-100">
                         <h4 class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">Quick Styling</h4>
                         <div class="flex gap-2">
                             <button onclick="setGlobalPrimary('#6366f1', '#4f46e5')" class="w-6 h-6 rounded-full bg-indigo-600 ring-2 ring-offset-2 ring-indigo-500"></button>
                             <button onclick="setGlobalPrimary('#f43f5e', '#e11d48')" class="w-6 h-6 rounded-full bg-rose-500"></button>
                             <button onclick="setGlobalPrimary('#10b981', '#059669')" class="w-6 h-6 rounded-full bg-emerald-500"></button>
                             <div class="flex-1"></div>
                             <button class="text-[10px] font-bold text-slate-400 hover:text-slate-900 px-3 py-1 rounded bg-slate-50">Advanced Studio</button>
                         </div>
                    </div>
                </div>

                <div class="p-6 bg-slate-950 text-white rounded-t-[2.5rem] mt-auto">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] text-indigo-400 mb-4 opacity-60">Editor Preview</p>
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-4">
                            <i data-lucide="smartphone" class="w-4 h-4 opacity-30"></i>
                            <i data-lucide="tablet" class="w-4 h-4 opacity-30"></i>
                            <i data-lucide="monitor" class="w-4 h-4 text-indigo-400"></i>
                        </div>
                        <span class="text-[9px] font-bold bg-white/10 px-2 py-1 rounded uppercase tracking-tighter">Sync Live</span>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function setGlobalPrimary(color, hover) {
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-hover', hover);
        }

        function setGlobalRadius(radius) {
            document.documentElement.style.setProperty('--radius-block', radius);
            document.querySelectorAll('.content-block, .rounded-xl, .rounded-3xl').forEach(el => {
                el.style.borderRadius = radius;
            });
        }

        function setGlobalFont(heading, body) {
            document.documentElement.style.setProperty('--font-heading', `'${heading}', sans-serif`);
            document.documentElement.style.setProperty('--font-body', `'${body}', sans-serif`);
            document.body.style.fontFamily = body;
        }

        function hideSidebarOnDelete() {
            renderWorkspaceDefault();
        }

        function renderTextSettings(container) {
            container.innerHTML = `
                <!-- 1. Selection Header -->
                <div class="sidebar-section-card border-l-4 border-l-indigo-500">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-bold text-indigo-900 leading-none">Text Block</p>
                            <p class="text-[10px] text-indigo-400 mt-1 uppercase tracking-wider font-bold">Concept Editor</p>
                        </div>
                    </div>
                </div>

                <!-- 2. Figma Style: Typography -->
                <div class="sidebar-section-card">
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-[11px] font-bold text-slate-900">Typography</label>
                        <i data-lucide="grid-3x3" class="w-3 h-3 text-slate-400"></i>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <select class="figma-input w-full bg-slate-50 border-slate-200" onchange="selectedBlockElement.style.fontFamily = this.value">
                                <option value="'Inter', sans-serif">Inter</option>
                                <option value="'Outfit', sans-serif">Outfit</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Space Mono', monospace">Space Mono</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-2">
                            <div class="w-3/5">
                                <select class="figma-input bg-slate-50 border-slate-200" onchange="selectedBlockElement.style.fontWeight = this.value">
                                    <option value="400">Regular</option>
                                    <option value="500">Medium</option>
                                    <option value="600">Semi Bold</option>
                                    <option value="700">Bold</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <input type="number" value="16" class="figma-input" oninput="selectedBlockElement.style.fontSize = this.value + 'px'">
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="figma-label">Line height</label>
                                <div class="relative">
                                    <i data-lucide="type" class="w-3 h-3 absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" value="Auto" class="figma-input pl-7">
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="figma-label">Letter spacing</label>
                                <div class="relative">
                                    <i data-lucide="move-horizontal" class="w-3 h-3 absolute left-2 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" value="0%" class="figma-input pl-7">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="figma-label">Alignment</label>
                            <div class="align-btn-group">
                                <button onclick="updateAlignment(this, 'left')" class="align-btn active"><i data-lucide="align-left" class="w-3.5 h-3.5 mx-auto"></i></button>
                                <button onclick="updateAlignment(this, 'center')" class="align-btn"><i data-lucide="align-center" class="w-3.5 h-3.5 mx-auto"></i></button>
                                <button onclick="updateAlignment(this, 'right')" class="align-btn"><i data-lucide="align-right" class="w-3.5 h-3.5 mx-auto"></i></button>
                                <button onclick="updateAlignment(this, 'justify')" class="align-btn"><i data-lucide="align-justify" class="w-3.5 h-3.5 mx-auto"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Figma Style: Fill -->
                <div class="sidebar-section-card">
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-[11px] font-bold text-slate-900">Fill</label>
                        <div class="flex gap-2">
                             <i data-lucide="grid-3x3" class="w-3 h-3 text-slate-400"></i>
                             <i data-lucide="plus" class="w-3 h-3 text-slate-400"></i>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <div id="fill-color-indicator" class="w-8 h-8 rounded border border-slate-200 bg-slate-900 cursor-pointer shadow-inner"></div>
                        <div class="flex-1">
                            <input type="text" value="0F172A" oninput="updateFillColor(this.value)" class="figma-input uppercase">
                        </div>
                        <div class="w-16">
                            <input type="text" value="100%" class="figma-input text-center">
                        </div>
                        <div class="flex gap-1">
                            <i data-lucide="eye" class="w-3 h-3 text-slate-400"></i>
                            <i data-lucide="minus" class="w-3 h-3 text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <!-- 4. Pedagogical Intent -->
                <div class="sidebar-section-card opacity-60 hover:opacity-100 transition-opacity">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 block">Pedagogical Intent</label>
                    <div class="flex flex-wrap gap-2">
                        <span class="setting-tag active" onclick="this.classList.toggle('active')">Explanatory</span>
                        <span class="setting-tag" onclick="this.classList.toggle('active')">Conceptual</span>
                        <span class="setting-tag" onclick="this.classList.toggle('active')">Exam-oriented</span>
                    </div>
                </div>

                <!-- 5. AI-Powered Enhancements -->
                <div class="sidebar-section-card bg-slate-50/50">
                    <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3 block flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> AI Smart Actions
                    </label>
                    <button class="ai-action-btn" onclick="triggerAIAction('simplify')">
                        <i data-lucide="zap" class="w-3.5 h-3.5 text-amber-500"></i> Simplify explanation
                    </button>
                    <button class="ai-action-btn" onclick="triggerAIAction('example')">
                        <i data-lucide="book-open" class="w-3.5 h-3.5 text-blue-500"></i> Add real-world example
                    </button>
                    <button class="ai-action-btn" onclick="insertCreatedBlock('quiz', true)">
                        <i data-lucide="help-circle" class="w-3.5 h-3.5 text-emerald-500"></i> Inject Quiz Below
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function updateAlignment(btn, align) {
            if (!selectedBlockElement) return;
            selectedBlockElement.style.textAlign = align;

            // Update UI state
            btn.parentElement.querySelectorAll('.align-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function updateFillColor(hex) {
            if (!selectedBlockElement) return;
            const cleanHex = hex.startsWith('#') ? hex : '#' + hex;
            if (/^#([0-9A-F]{3}){1,2}$/i.test(cleanHex)) {
                selectedBlockElement.style.color = cleanHex;
                const indicator = document.getElementById('fill-color-indicator');
                if (indicator) indicator.style.backgroundColor = cleanHex;
            }
        }

        // --- AI ACTION ENGINE ---
        function triggerAIAction(action) {
            if (!selectedBlockElement) return;
            const p = selectedBlockElement.querySelector('p[contenteditable="true"]') || selectedBlockElement.querySelector('p');
            if (!p) return;

            const originalText = p.innerText;
            p.classList.add('animate-pulse', 'text-indigo-400');

            setTimeout(() => {
                p.classList.remove('animate-pulse', 'text-indigo-400');
                switch (action) {
                    case 'simplify':
                        p.innerText = "In simpler terms: " + originalText.split('.')[0] + ". This makes the concept much easier to grasp for beginners.";
                        break;
                    case 'example':
                        p.insertAdjacentHTML('afterend', `<p class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 text-xs text-blue-700 italic">Example: Think of this like a physical library where books are nodes and aisles are memory links.</p>`);
                        break;
                    case 'bulletize':
                        const sentences = originalText.split('.').filter(s => s.trim().length > 0);
                        p.innerHTML = `<ul class="list-disc list-inside space-y-2 mt-2">${sentences.map(s => `<li>${s.trim()}</li>`).join('')}</ul>`;
                        break;
                    case 'question':
                        insertCreatedBlock('quiz', true);
                        break;
                }
            }, 800);
        }

        function renderFlipcardSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Card Management</label>
                    <button onclick="addFlipcard()" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="plus" class="w-3 h-3"></i> Add New Card
                    </button>
                    <div id="card-list-items" class="space-y-2"></div>
                </div>
            `;

            const list = container.querySelector('#card-list-items');
            const cards = selectedBlockElement.querySelectorAll('.flip-container');
            cards.forEach((card, idx) => {
                const front = card.querySelector('.flip-card-front');
                const back = card.querySelector('.flip-card-back');
                const currentColor = front.style.backgroundColor || 'rgb(79, 70, 229)';

                const item = document.createElement('div');
                item.className = 'flex flex-col gap-3 p-3 bg-white border border-slate-100 rounded-xl shadow-sm';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-black text-slate-400">CARD 0${idx + 1}</span>
                        <button onclick="selectedBlockElement.querySelectorAll('.flip-container')[${idx}].remove(); renderFlipcardSettings(document.getElementById('block-settings-render-area'))" class="text-slate-300 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="flex gap-1.5 flex-wrap">
                        <button onclick="updateSingleFlipcardTemplate(${idx}, '#4f46e5')" class="w-5 h-5 rounded-md bg-indigo-600 border border-white/20 shadow-sm" title="Indigo"></button>
                        <button onclick="updateSingleFlipcardTemplate(${idx}, '#f43f5e')" class="w-5 h-5 rounded-md bg-rose-500 border border-white/20 shadow-sm" title="Rose"></button>
                        <button onclick="updateSingleFlipcardTemplate(${idx}, '#10b981')" class="w-5 h-5 rounded-md bg-emerald-500 border border-white/20 shadow-sm" title="Emerald"></button>
                        <button onclick="updateSingleFlipcardTemplate(${idx}, '#f59e0b')" class="w-5 h-5 rounded-md bg-amber-500 border border-white/20 shadow-sm" title="Amber"></button>
                        <button onclick="updateSingleFlipcardTemplate(${idx}, '#0f172a')" class="w-5 h-5 rounded-md bg-slate-900 border border-white/20 shadow-sm" title="Midnight"></button>
                        <div class="w-px h-5 bg-slate-100 mx-0.5"></div>
                        <div class="relative w-5 h-5 rounded-md border border-slate-200 overflow-hidden bg-gradient-to-br from-indigo-500 via-rose-500 to-emerald-500">
                             <input type="color" value="${rgbToHex(currentColor)}" oninput="updateSingleFlipcardTemplate(${idx}, this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full scale-150">
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function updateSingleFlipcardTemplate(index, color) {
            if (!selectedBlockElement) return;
            const cards = selectedBlockElement.querySelectorAll('.flip-container');
            if (cards[index]) {
                const front = cards[index].querySelector('.flip-card-front');
                const back = cards[index].querySelector('.flip-card-back');

                front.style.backgroundColor = color;
                front.style.borderColor = color;

                // Sync the back border for professional finish
                back.style.borderColor = color;
            }
        }

        function addFlipcard() {
            const grid = selectedBlockElement;
            const idx = grid.querySelectorAll('.flip-container').length + 1;
            const newCard = `
                <div class="flip-container h-[200px]">
                    <div class="flip-card-inner">
                        <div class="flip-card-front bg-indigo-600 text-white shadow-lg cursor-pointer transition-colors" onclick="toggleFlip(this.parentElement)">
                            <p contenteditable="true" class="text-xs font-bold uppercase tracking-widest opacity-70 mb-2" onclick="event.stopPropagation()">Question ${idx}</p>
                            <p contenteditable="true" class="text-sm font-medium" onclick="event.stopPropagation()">Click to reveal</p>
                        </div>
                        <div class="flip-card-back bg-white border-2 border-indigo-600 text-indigo-900 shadow-lg cursor-pointer transition-colors" onclick="toggleFlip(this.parentElement)">
                            <p contenteditable="true" class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-2" onclick="event.stopPropagation()">Answer</p>
                            <p contenteditable="true" class="text-xs leading-relaxed" onclick="event.stopPropagation()">New explanation text...</p>
                        </div>
                    </div>
                </div>`;
            grid.insertAdjacentHTML('beforeend', newCard);
            renderFlipcardSettings(document.getElementById('block-settings-render-area'));
        }

        function renderChartSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Global Axis Titles</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Y-Axis (Vertical)</label>
                            <input type="text" value="${selectedBlockElement.querySelector('.y-axis-label')?.innerText || ''}" class="figma-input mt-1" oninput="selectedBlockElement.querySelector('.y-axis-label').innerText = this.value">
                        </div>
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">X-Axis (Title)</label>
                            <input type="text" value="${selectedBlockElement.querySelector('.x-axis-title')?.innerText || ''}" class="figma-input mt-1" oninput="selectedBlockElement.querySelector('.x-axis-title').innerText = this.value">
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card mt-4">
                    <label class="figma-label mb-3">Data Categories</label>
                    <button onclick="addChartBar()" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="plus" class="w-3 h-3"></i> Add Data Bar
                    </button>
                    <div id="chart-bar-list" class="space-y-4"></div>
                </div>
            `;

            const list = container.querySelector('#chart-bar-list');
            const bars = selectedBlockElement.querySelectorAll('.bar-item');
            bars.forEach((bar, idx) => {
                const label = selectedBlockElement.querySelectorAll('.x-axis-labels span')[idx];
                const row = document.createElement('div');
                row.className = 'space-y-2 p-2 bg-slate-50/50 rounded-lg border border-slate-100';
                row.innerHTML = `
                    <div class="flex justify-between items-center text-[10px] font-bold text-slate-400 capitalize">
                        <span>DATA POINT ${idx + 1}</span>
                        <button onclick="removeChartBar(${idx})" class="hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                    <div class="flex gap-2">
                         <div class="flex-1">
                            <label class="text-[8px] text-slate-400 uppercase font-bold">Label</label>
                            <input type="text" value="${label ? label.innerText : ''}" class="figma-input mt-1" oninput="updateChartLabel(${idx}, this.value)">
                         </div>
                         <div class="w-20">
                            <label class="text-[8px] text-slate-400 uppercase font-bold">Value (%)</label>
                            <input type="number" value="${parseInt(bar.style.height)}" class="figma-input mt-1" oninput="selectedBlockElement.querySelectorAll('.bar-item')[${idx}].style.height = this.value + '%'; selectedBlockElement.querySelectorAll('.bar-item')[${idx}].querySelector('.bar-tooltip').innerText = this.value + '%'">
                         </div>
                    </div>
                `;
                list.appendChild(row);
            });
            lucide.createIcons();
        }

        function updateChartLabel(idx, val) {
            const label = selectedBlockElement.querySelectorAll('.x-axis-labels span')[idx];
            if (label) label.innerText = val;
        }

        function removeChartBar(idx) {
            selectedBlockElement.querySelectorAll('.bar-item')[idx].remove();
            const labels = selectedBlockElement.querySelectorAll('.x-axis-labels span');
            if (labels[idx]) labels[idx].remove();
            renderChartSettings(document.getElementById('block-settings-render-area'));
        }

        function addChartBar() {
            const container = selectedBlockElement.querySelector('.bar-chart-container');
            const labelContainer = selectedBlockElement.querySelector('.x-axis-labels');

            const barHtml = `
                <div class="bar-item group relative" style="height: 40%; min-height: 10px;">
                    <div class="bar-tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-all pointer-events-none">40%</div>
                </div>`;
            const labelHtml = `<span contenteditable="true" class="text-[9px] font-bold text-slate-400 uppercase outline-none">NEW</span>`;

            container.insertAdjacentHTML('beforeend', barHtml);
            labelContainer.insertAdjacentHTML('beforeend', labelHtml);
            renderChartSettings(document.getElementById('block-settings-render-area'));
        }

        function renderCodeSettings(container) {
            const row = document.createElement('div');
            row.className = 'space-y-4';
            row.innerHTML = `
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Language</label>
                    <select onchange="selectedBlockElement.querySelector('.lang-selector').value = this.value; highlightCode(selectedBlockElement.querySelector('code'))" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs">
                        <option value="javascript">JavaScript</option>
                        <option value="python">Python</option>
                        <option value="html">HTML</option>
                        <option value="css">CSS</option>
                    </select>
                </div>
            `;
            container.appendChild(row);
        }

        function renderHotspotSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <button onclick="document.getElementById('global-image-upload').click()" class="w-full py-2.5 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-colors mb-4 flex items-center justify-center gap-2">
                        <i data-lucide="upload" class="w-3.5 h-3.5"></i> Update Image
                    </button>
                    <button onclick="addHotspot()" class="w-full py-2.5 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-3.5 h-3.5"></i> Add Point
                    </button>
                    <p class="text-[9px] text-slate-400 mt-3 text-center italic">Tip: Select a point below, then click on the image to position it.</p>
                </div>
                <div id="hotspot-list" class="space-y-3"></div>
            `;

            const list = container.querySelector('#hotspot-list');
            const dots = selectedBlockElement.querySelectorAll('.hotspot');
            dots.forEach((dot, idx) => {
                const card = document.createElement('div');
                card.className = `sidebar-section-card cursor-pointer transition-all border-2 ${activeHotspotIndex === idx ? 'border-indigo-500 bg-indigo-50/10' : 'border-transparent'}`;
                card.onclick = () => {
                    activeHotspotIndex = idx;
                    renderHotspotSettings(document.getElementById('block-settings-render-area'));
                };
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-bold ${activeHotspotIndex === idx ? 'text-indigo-600' : 'text-slate-400'}">POINT ${idx + 1}</span>
                        <div class="flex gap-2">
                             <input type="color" value="${rgbToHex(dot.style.backgroundColor) || '#6366f1'}" oninput="selectedBlockElement.querySelectorAll('.hotspot')[${idx}].style.backgroundColor = this.value" class="w-4 h-4 border-none bg-transparent cursor-pointer">
                             <button onclick="event.stopPropagation(); this.closest('.sidebar-section-card').remove(); selectedBlockElement.querySelectorAll('.hotspot')[${idx}].remove(); activeHotspotIndex = null;" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function rgbToHex(rgb) {
            if (!rgb) return null;
            const parts = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!parts) return null;
            delete (parts[0]);
            for (let i = 1; i <= 3; ++i) {
                parts[i] = parseInt(parts[i]).toString(16);
                if (parts[i].length == 1) parts[i] = '0' + parts[i];
            }
            return '#' + parts.join('');
        }

        function moveActiveHotspot(e) {
            if (activeHotspotIndex === null || !selectedBlockElement) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            const dot = selectedBlockElement.querySelectorAll('.hotspot')[activeHotspotIndex];
            if (dot) {
                dot.style.left = x + '%';
                dot.style.top = y + '%';
            }
        }

        function addHotspot() {
            const tray = selectedBlockElement.querySelector('.aspect-video');
            const dot = document.createElement('div');
            dot.className = 'hotspot';
            dot.style.top = '50%';
            dot.style.left = '50%';
            dot.onclick = (e) => { e.stopPropagation(); handleHotspot(dot, true); };
            tray.appendChild(dot);
            renderHotspotSettings(document.getElementById('block-settings-render-area'));
        }

        function renderQuizSettings(container) {
            const btn = document.createElement('button');
            btn.className = 'w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors mb-4';
            btn.innerText = 'Add Choice Option';
            container.appendChild(btn);

            const hint = document.createElement('p');
            hint.className = 'text-[10px] text-slate-400 italic';
            hint.innerText = 'Quiz editor is being expanded. Currently, use AI tools to generate variants.';
            container.appendChild(hint);
        }

        function renderSequenceSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Sequence Steps</label>
                    <button onclick="addSequenceStep()" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="list-plus" class="w-3.5 h-3.5"></i> Add Step
                    </button>
                    <div id="sequence-list" class="space-y-2"></div>
                </div>
                <div class="sidebar-section-card mt-4 bg-emerald-50/20 border-emerald-100">
                    <p class="text-[10px] text-emerald-600 font-bold mb-1 uppercase tracking-tight">Correct Sequence Defined</p>
                    <p class="text-[10px] text-slate-500 leading-relaxed italic">The order shown here is what students must achieve. Use AI to generate logical variations.</p>
                </div>
            `;
            const list = container.querySelector('#sequence-list');
            const steps = selectedBlockElement.querySelectorAll('.space-y-3 > div');
            steps.forEach((step, idx) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2 p-2 bg-slate-50 border border-slate-100 rounded-lg';
                item.innerHTML = `
                    <div class="w-4 h-4 rounded-full bg-slate-200 flex items-center justify-center text-[8px] font-bold text-slate-500">${idx + 1}</div>
                    <span class="text-[10px] text-slate-600 truncate flex-1">${step.querySelector('span').innerText}</span>
                    <button onclick="selectedBlockElement.querySelectorAll('.space-y-3 > div')[${idx}].remove(); renderSequenceSettings(document.getElementById('block-settings-render-area'))" class="text-slate-300 hover:text-red-500">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function addSequenceStep() {
            const tray = selectedBlockElement.querySelector('.space-y-3');
            const idx = tray.children.length + 1;
            const html = `
                <div class="p-3 bg-white border border-slate-200 rounded-lg text-xs font-medium flex items-center gap-3">
                    <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center text-[10px] font-bold text-slate-400">${idx}</div>
                    <span contenteditable="true">New Scientific Step</span>
                </div>`;
            tray.insertAdjacentHTML('beforeend', html);
            renderSequenceSettings(document.getElementById('block-settings-render-area'));
        }

        function renderExpandableSettings(container) {
            renderTextSettings(container);

            const themeSection = document.createElement('div');
            themeSection.className = 'sidebar-section-card mt-4';
            themeSection.innerHTML = `
                <label class="text-[10px] font-bold text-slate-400 uppercase mb-3 block">Box Theme</label>
                <div class="flex gap-2">
                    <button onclick="selectedBlockElement.querySelector('.bg-white, .bg-indigo-50, .bg-slate-900').className = 'bg-indigo-50 p-6 rounded-xl border border-indigo-100'" class="flex-1 h-8 rounded bg-indigo-100"></button>
                    <button onclick="selectedBlockElement.querySelector('.bg-white, .bg-indigo-50, .bg-slate-900').className = 'bg-slate-900 p-6 rounded-xl text-white'" class="flex-1 h-8 rounded bg-slate-900"></button>
                    <button onclick="selectedBlockElement.querySelector('.bg-white, .bg-indigo-50, .bg-slate-900').className = 'bg-white p-6 rounded-xl border border-slate-200'" class="flex-1 h-8 rounded bg-white border border-slate-200"></button>
                </div>
            `;
            container.appendChild(themeSection);
        }

        function renderGallerySettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Design Template</label>
                    <div class="grid grid-cols-2 gap-2 mb-6">
                        <button onclick="updateGalleryTemplate('template-classic')" class="p-2 border border-slate-200 rounded text-[10px] font-bold hover:bg-slate-50 transition-all">Classic</button>
                        <button onclick="updateGalleryTemplate('template-dark')" class="p-2 bg-slate-900 text-white rounded text-[10px] font-bold hover:bg-slate-800 transition-all">Dark</button>
                        <button onclick="updateGalleryTemplate('template-gradient')" class="p-2 bg-indigo-600 text-white rounded text-[10px] font-bold hover:bg-indigo-700 transition-all">Gradient</button>
                        <button onclick="updateGalleryTemplate('template-minimal')" class="p-2 bg-slate-100 border border-slate-200 rounded text-[10px] font-bold hover:bg-slate-200 transition-all text-slate-600">Minimal</button>
                    </div>

                    <label class="figma-label mb-3">Quote Gallery</label>
                    <button onclick="addGalleryItem()" class="w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2 mb-4">
                        <i data-lucide="plus-square" class="w-3.5 h-3.5"></i> Add Quote Card
                    </button>
                    <div id="gallery-list" class="space-y-2"></div>
                </div>
            `;
            const list = container.querySelector('#gallery-list');
            const items = selectedBlockElement.querySelectorAll('.quote-card');
            items.forEach((item, idx) => {
                const row = document.createElement('div');
                row.className = 'flex flex-col gap-2 p-3 bg-white border border-slate-100 rounded-xl shadow-sm';
                row.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] text-slate-500 truncate max-w-[120px] font-medium italic">"${item.querySelector('p').innerText}"</span>
                        <button onclick="selectedBlockElement.querySelectorAll('.quote-card')[${idx}].remove(); renderGallerySettings(document.getElementById('block-settings-render-area'))" class="text-slate-300 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="flex gap-1.5 items-center mt-1">
                        <button onclick="updateSingleCardTemplate(${idx}, 'template-classic')" class="w-4 h-4 rounded-full border border-slate-200 bg-white" title="Classic"></button>
                        <button onclick="updateSingleCardTemplate(${idx}, 'template-dark')" class="w-4 h-4 rounded-full bg-slate-900" title="Dark"></button>
                        <button onclick="updateSingleCardTemplate(${idx}, 'template-gradient')" class="w-4 h-4 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600" title="Gradient"></button>
                        <button onclick="updateSingleCardTemplate(${idx}, 'template-minimal')" class="w-4 h-4 rounded-full bg-slate-100 border-l-2 border-l-indigo-500" title="Minimal"></button>
                        <span class="text-[9px] text-slate-400 font-bold uppercase ml-auto tracking-tighter">Template</span>
                    </div>
                `;
                list.appendChild(row);
            });
            lucide.createIcons();
        }

        function updateGalleryTemplate(templateClass) {
            if (!selectedBlockElement) return;
            const cards = selectedBlockElement.querySelectorAll('.quote-card');
            cards.forEach(card => {
                card.classList.remove('template-classic', 'template-dark', 'template-gradient', 'template-minimal');
                card.classList.add(templateClass);
            });
        }

        function updateSingleCardTemplate(index, templateClass) {
            if (!selectedBlockElement) return;
            const cards = selectedBlockElement.querySelectorAll('.quote-card');
            if (cards[index]) {
                cards[index].classList.remove('template-classic', 'template-dark', 'template-gradient', 'template-minimal');
                cards[index].classList.add(templateClass);
            }
        }

        function addGalleryItem() {
            const tray = selectedBlockElement;
            const currentTemplate = tray.querySelector('.quote-card')?.classList.contains('template-dark') ? 'template-dark' :
                tray.querySelector('.quote-card')?.classList.contains('template-gradient') ? 'template-gradient' :
                    tray.querySelector('.quote-card')?.classList.contains('template-minimal') ? 'template-minimal' : 'template-classic';

            const html = `
                <div class="quote-card ${currentTemplate} border border-slate-200 p-5 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                    <i data-lucide="quote" class="w-6 h-6 text-indigo-100 group-hover:text-indigo-600 transition-colors mb-4"></i>
                    <p contenteditable="true" class="text-xs text-slate-600 italic leading-relaxed" onclick="event.stopPropagation()">"New inspiring quote here..."</p>
                    <p contenteditable="true" class="text-[10px] font-bold text-slate-400 mt-4 uppercase tracking-widest" onclick="event.stopPropagation()">— Author Name</p>
                </div>`;
            tray.insertAdjacentHTML('beforeend', html);
            lucide.createIcons();
            renderGallerySettings(document.getElementById('block-settings-render-area'));
        }

        function renderSortingSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label">Categorization Engine</label>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="addSortingCategory()" class="py-2 bg-slate-50 border border-slate-100 rounded text-[9px] font-bold text-slate-600 hover:bg-white transition-all">+ CATEGORY</button>
                        <button onclick="addSortingItem()" class="py-2 bg-indigo-50 border border-indigo-100 rounded text-[9px] font-bold text-indigo-600 hover:bg-white transition-all">+ ITEM</button>
                    </div>
                </div>
                <div class="sidebar-section-card opacity-60">
                     <p class="text-[10px] text-slate-500 leading-relaxed italic">Tip: Drag items into different categories to set the "Correct" target state.</p>
                </div>
            `;
        }

        function addSortingCategory() {
            const grid = selectedBlockElement.querySelector('.grid.grid-cols-2');
            const html = `
                <div ondragover="handleDragOverSorting(event)" ondrop="handleDropSorting(event)" data-accept="new" class="h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center p-4 transition-colors hover:border-indigo-300">
                    <span contenteditable="true" class="text-[10px] font-bold text-slate-400 uppercase mb-4">New Category</span>
                </div>`;
            grid.insertAdjacentHTML('beforeend', html);
        }

        function addSortingItem() {
            const tray = selectedBlockElement.querySelector('.flex.gap-4');
            const id = 'p-' + Date.now();
            const html = `<div id="${id}" contenteditable="true" draggable="true" ondragstart="handleDragStartSorting(event)" data-type="new" class="px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-full text-xs font-bold text-indigo-600 cursor-grab outline-none focus:ring-2 focus:ring-indigo-400">New Item</div>`;
            tray.insertAdjacentHTML('beforeend', html);
        }

        function renderBranchingSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Choice Management</label>
                    <button onclick="addScenarioChoice()" class="w-full py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 mb-4 shadow-sm">
                        <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> Add Choice Branch
                    </button>
                    <div id="choice-list" class="space-y-2"></div>
                </div>
            `;
            const list = container.querySelector('#choice-list');
            const btns = selectedBlockElement.querySelectorAll('.scenario-buttons button');
            btns.forEach((btn, idx) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-white border border-slate-100 rounded-lg';
                item.innerHTML = `
                    <span class="text-[10px] font-medium text-slate-600 truncate max-w-[120px]">${btn.innerText}</span>
                    <button onclick="selectedBlockElement.querySelectorAll('.scenario-buttons button')[${idx}].remove(); renderBranchingSettings(document.getElementById('block-settings-render-area'))" class="text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function addScenarioChoice() {
            const tray = selectedBlockElement.querySelector('.scenario-buttons');
            const html = `<button contenteditable="true" class="px-6 py-3 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl text-xs font-bold transition-all">New Choice</button>`;
            tray.insertAdjacentHTML('beforeend', html);
            renderBranchingSettings(document.getElementById('block-settings-render-area'));
        }

        function handleGlobalImageUpload(files) {
            if (!files || !files[0] || !selectedBlockElement) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                // Check if it's a hotspot or standard image block
                const imgContainer = selectedBlockElement.querySelector('.aspect-video');
                if (imgContainer) {
                    imgContainer.style.backgroundImage = `url(${e.target.result})`;
                    imgContainer.style.backgroundSize = 'cover';
                    imgContainer.style.backgroundPosition = 'center';
                    const icon = imgContainer.querySelector('i[data-lucide="image"]');
                    if (icon) icon.parentElement.style.display = 'none';
                }
            };
            reader.readAsDataURL(files[0]);
        }

        function renderVideoSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card border-l-4 border-l-indigo-500">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i data-lucide="video" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-bold text-indigo-900 leading-none">Video Block</p>
                            <p class="text-[10px] text-indigo-400 mt-1 uppercase tracking-wider font-bold">Media Controller</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card">
                    <label class="figma-label mb-3 text-indigo-600">Live Transcript</label>
                    <div id="transcript-upload-area" class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-indigo-300 transition-colors cursor-pointer group" onclick="document.getElementById('transcript-file-input').click()">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-slate-300 group-hover:text-indigo-500 mx-auto mb-2 transition-colors"></i>
                        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Upload .vtt or .txt</p>
                        <p class="text-[9px] text-slate-400 mt-1">Files will be synced with video timeline</p>
                        <input type="file" id="transcript-file-input" class="hidden" accept=".vtt,.txt" onchange="handleTranscriptUpload(this.files)">
                    </div>
                    
                    <div id="transcript-preview" class="hidden mt-4 space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Live Sync Status</span>
                            <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 text-[9px] font-bold rounded-full">ACTIVE</span>
                        </div>
                        <div class="bg-slate-50 border border-slate-100 rounded-lg p-3 max-h-32 overflow-y-auto">
                            <p class="text-[10px] text-slate-600 leading-relaxed font-mono">00:01:24 - "Now we look at BST rotation..."</p>
                            <p class="text-[10px] text-slate-400 leading-relaxed font-mono mt-2">00:01:30 - "The AVL algorithm ensures..."</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card">
                    <label class="figma-label">Video Source URL</label>
                    <input type="text" class="figma-input mt-1" value="https://youtube.com/embed/..." placeholder="Enter embed URL">
                </div>
            `;
            lucide.createIcons();
        }

        function renderClozeSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card border-l-4 border-l-indigo-500">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i data-lucide="text-cursor-input" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-bold text-indigo-900 leading-none">Cloze Activity</p>
                            <p class="text-[10px] text-indigo-400 mt-1 uppercase tracking-wider font-bold">recall engine</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Validation Rules</label>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tight">Case Sensitive</span>
                            <div class="w-8 h-4 bg-slate-200 rounded-full relative cursor-pointer">
                                <div class="w-3 h-3 bg-white rounded-full absolute left-0.5 top-0.5 shadow-sm"></div>
                            </div>
                        </div>
                        <p class="text-[9px] text-slate-400 leading-relaxed">Authors can set specific answers by modifying the <code>data-answer</code> attribute of each blank in the code view or clicking the blank directly.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderDecisionSettings(container) {
            container.innerHTML = `
                <div class="sidebar-section-card border-l-4 border-l-indigo-500">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i data-lucide="message-square-quote" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-bold text-indigo-900 leading-none">Scenario Decision</p>
                            <p class="text-[10px] text-indigo-400 mt-1 uppercase tracking-wider font-bold">critical thinking</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Choice Architecture</label>
                    <button onclick="addDecisionChoice()" class="w-full py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold hover:bg-indigo-700 transition-all flex items-center justify-center gap-2 shadow-sm mb-4">
                        <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i> Add New Perspective
                    </button>
                    <div class="space-y-2" id="decision-choice-list"></div>
                </div>
            `;

            const list = container.querySelector('#decision-choice-list');
            const choices = selectedBlockElement.querySelectorAll('.choice-stack button');
            choices.forEach((choice, idx) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-white border border-slate-100 rounded-lg';
                item.innerHTML = `
                    <span class="text-[10px] font-medium text-slate-600 truncate max-w-[150px]">${choice.querySelector('span').innerText}</span>
                    <button onclick="selectedBlockElement.querySelectorAll('.choice-stack button')[${idx}].remove(); renderDecisionSettings(document.getElementById('block-settings-render-area'))" class="text-slate-300 hover:text-red-500 transition-colors">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function renderUploadSettings(container) {
            const hasFile = selectedBlockElement.getAttribute('data-has-file') === 'true';
            const intent = selectedBlockElement.getAttribute('data-intent') || 'none';

            container.innerHTML = `
                <div class="sidebar-section-card border-l-4 border-l-indigo-600">
                    <div class="flex items-center gap-3 mb-1">
                        <div class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center">
                            <i data-lucide="file-up" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-[11px] font-bold text-indigo-900 leading-none">Smart Resource</p>
                            <p class="text-[10px] text-indigo-400 mt-1 uppercase tracking-wider font-bold">Knowledge Engine</p>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section-card">
                    <label class="figma-label mb-3">Pedagogical Guardrails</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Difficulty level</label>
                            <div class="flex gap-1 mt-1">
                                <button class="flex-1 py-1 text-[9px] font-bold border rounded bg-white hover:border-indigo-500">Beginner</button>
                                <button class="flex-1 py-1 text-[9px] font-bold border rounded bg-indigo-600 text-white">Intermediate</button>
                                <button class="flex-1 py-1 text-[9px] font-bold border rounded bg-white hover:border-indigo-500">Advanced</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                            <span class="text-[10px] font-medium text-slate-600">Mandatory Interaction</span>
                            <div class="w-8 h-4 bg-indigo-600 rounded-full relative cursor-pointer">
                                <div class="w-3 h-3 bg-white rounded-full absolute right-0.5 top-0.5 shadow-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>

                ${hasFile ? `
                    <div class="sidebar-section-card bg-indigo-50/50 border-indigo-100">
                        <label class="text-[10px] font-bold text-indigo-600 uppercase tracking-widest mb-3 block flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-3 h-3"></i> AI Smart Suggestions
                        </label>
                        <div class="p-3 bg-white rounded-xl border border-indigo-100 mb-3">
                            <p class="text-[10px] text-slate-600 leading-relaxed italic">"This file is dense. Should I simplify it for beginners or extract the key takeaways?"</p>
                        </div>
                        <div class="space-y-2">
                            <button class="ai-action-btn" onclick="triggerAIFileAction('simplify')">
                                <i data-lucide="zap" class="w-3.5 h-3.5 text-amber-500"></i> Simplify content
                            </button>
                            <button class="ai-action-btn" onclick="triggerAIFileAction('highlights')">
                                <i data-lucide="list" class="w-3.5 h-3.5 text-blue-500"></i> Extract Highlights
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
            lucide.createIcons();
        }

        function triggerAIFileAction(action) {
            // Mock AI behavior for files
            alert(`AI Suggestion: Processing "${action}" on uploaded content...`);
        }

        function addDecisionChoice() {
            const tray = selectedBlockElement.querySelector('.choice-stack');
            const html = `
                <button class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left text-sm font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-between items-center group">
                    <span contenteditable="true">New Scenario Choice</span>
                    <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all"></i>
                </button>`;
            tray.insertAdjacentHTML('beforeend', html);
            lucide.createIcons();
            renderDecisionSettings(document.getElementById('block-settings-render-area'));
        }

        function handleTranscriptUpload(files) {
            if (!files || !files[0]) return;
            const statusArea = document.getElementById('transcript-upload-area');
            const preview = document.getElementById('transcript-preview');

            // Visual feedback
            statusArea.classList.add('bg-indigo-50/50', 'border-indigo-200');
            statusArea.querySelector('p').innerText = files[0].name;
            statusArea.querySelector('i').classList.replace('text-slate-300', 'text-indigo-600');

            preview.classList.remove('hidden');
            preview.classList.add('animate-in', 'fade-in', 'slide-in-from-top-2');
        }

        function handleClozeCheck(container) {
            const blanks = container.querySelectorAll('.cloze-text span');
            blanks.forEach(blank => {
                const expected = blank.getAttribute('data-answer')?.toLowerCase().trim();
                const actual = blank.innerText.toLowerCase().trim();

                if (actual === expected) {
                    blank.classList.remove('text-indigo-600', 'border-indigo-400', 'text-red-500', 'border-red-400');
                    blank.classList.add('text-emerald-600', 'border-emerald-400');
                } else {
                    blank.classList.remove('text-indigo-600', 'border-indigo-400', 'text-emerald-600', 'border-emerald-400');
                    blank.classList.add('text-red-500', 'border-red-400');
                }
            });
        }

        function updateContextSidebar(type) {
            const data = contextInsights[type];
            if (!data) return;

            // Update Header
            document.getElementById('context-selection-text').innerText = data.title;

            // Update Insight
            document.getElementById('pedagogy-insight-text').innerText = data.insight;

            // Update AI Question
            document.getElementById('ai-question-text').innerText = data.question;

            // Update Answers
            const list = document.getElementById('ai-answers-container');
            list.innerHTML = '';
            data.answers.forEach(ans => {
                const item = document.createElement('div');
                item.className = `flex items-center gap-2 p-1.5 rounded bg-white border ${ans.correct ? 'border-green-200 ring-1 ring-green-100' : 'border-slate-200'}`;

                const circle = document.createElement('div');
                circle.className = `w-3 h-3 rounded-full ${ans.correct ? 'border-[3px] border-green-500 bg-white' : 'border border-slate-300'}`;

                const span = document.createElement('span');
                span.className = `text-xs ${ans.correct ? 'text-slate-900 font-medium' : 'text-slate-600'}`;
                span.innerText = ans.text;

                item.appendChild(circle);
                item.appendChild(span);

                if (ans.correct) {
                    const check = document.createElement('i');
                    check.setAttribute('data-lucide', 'check');
                    check.className = 'w-3 h-3 text-green-500 ml-auto';
                    item.appendChild(check);
                }

                list.appendChild(item);
            });

            lucide.createIcons();

            // Auto open right sidebar if it's collapsed
            const rightSidebar = document.getElementById('rightSidebar');
            if (rightSidebar.classList.contains('collapsed')) {
                toggleSidebar('right');
            }
        }

        // --- SLASH COMMAND MENU LOGIC ---
        function handleEditorInput(e) {
            hideSlashMenu();
        }

        function handleEditorKeyDown(e) {
            // This can stay for focused interaction
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                showSlashMenu(e.target);
            } else if (e.key === 'Escape') {
                hideSlashMenu();
            }
        }

        // Global Shortcut for Ctrl + /
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '/') {
                const trigger = document.getElementById('editor-trigger');
                if (trigger) {
                    e.preventDefault();
                    showSlashMenu(trigger);
                    trigger.focus();
                }
            }
        });

        function showSlashMenu(trigger) {
            const menu = document.getElementById('slashMenu');
            const rect = trigger.getBoundingClientRect();

            // Position menu above or below based on space
            menu.style.display = 'block';
            menu.style.left = `${rect.left}px`;
            menu.style.top = `${rect.top - menu.offsetHeight - 10}px`; // Default to above

            // If it goes off screen top, show below
            if (rect.top - menu.offsetHeight < 0) {
                menu.style.top = `${rect.bottom + 10}px`;
            }
        }

        function hideSlashMenu() {
            document.getElementById('slashMenu').style.display = 'none';
        }

        function insertCreatedBlock(type, injectBelow = false) {
            const trigger = document.getElementById('editor-trigger');
            const targetContainer = (injectBelow && selectedBlockElement) ? selectedBlockElement : trigger;
            const position = (injectBelow && selectedBlockElement) ? 'afterend' : 'beforebegin';

            let newBlockHtml = '';
            const id = 'block-' + Date.now();

            switch (type) {
                case 'text':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'text')" class="content-block group relative rounded-xl hover:bg-slate-50 -mx-4 p-4 transition-all border border-transparent hover:border-slate-100 cursor-pointer animate-in fade-in slide-in-from-bottom-2">
                            <h3 contenteditable="true" class="text-lg font-medium text-slate-900 mb-2">New Text Block</h3>
                            <p contenteditable="true" class="text-base text-slate-600 leading-relaxed">Start typing your educational content here...</p>
                        </div>`;
                    break;
                case 'heading':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'text')" class="content-block group relative rounded-xl hover:bg-slate-50 -mx-4 p-4 transition-all border border-transparent hover:border-slate-100 cursor-pointer animate-in fade-in slide-in-from-bottom-2">
                            <h2 contenteditable="true" class="text-2xl font-bold text-slate-900 mb-2">New Heading</h2>
                        </div>`;
                    break;
                case 'code':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'code')" class="content-block relative group ring-offset-2 rounded-xl cursor-pointer mt-8 animate-in fade-in slide-in-from-bottom-2">
                            <div class="active-indicator absolute -right-3 top-4 translate-x-full hidden items-center gap-2">
                                <div class="bg-indigo-600 text-white text-xs font-medium px-2 py-1 rounded-md shadow-sm arrow-left">Active</div>
                            </div>
                            <div class="bg-slate-900 rounded-xl p-6 font-mono text-sm overflow-hidden text-slate-300 shadow-sm transition-all border-2 border-transparent">
                                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                                    <div class="flex items-center gap-3">
                                        <span contenteditable="true" class="text-slate-400 text-xs uppercase tracking-wider">CODE SNIPPET</span>
                                        <select onchange="updateCodeTheme(this)" class="bg-slate-800 text-[10px] text-slate-500 border border-slate-700 rounded px-1.5 py-0.5 outline-none focus:border-indigo-500 transition-colors">
                                            <option value="theme-default">Default Theme</option>
                                            <option value="theme-midnight">Midnight Dark</option>
                                            <option value="theme-forest">Deep Forest</option>
                                        </select>
                                    </div>
                                    <select onchange="highlightCode(this.closest('.content-block').querySelector('code'))" class="lang-selector bg-transparent text-xs text-slate-500 outline-none border-none cursor-pointer hover:text-indigo-400 transition-colors appearance-none">
                                        <option value="javascript">JavaScript</option>
                                        <option value="python">Python</option>
                                        <option value="html">HTML</option>
                                        <option value="css">CSS</option>
                                    </select>
                                </div>
                                <pre><code contenteditable="true" class="outline-none" oninput="highlightCode(this)">// Type your code here...</code></pre>
                            </div>
                        </div>`;
                    break;
                case 'quiz':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'text')" class="content-block group relative rounded-xl hover:bg-slate-50 p-6 transition-all border-2 border-dashed border-indigo-200 bg-indigo-50/20 cursor-pointer animate-in fade-in slide-in-from-bottom-2">
                            <div class="flex items-center gap-3 mb-4 text-indigo-600">
                                <i data-lucide="help-circle" class="w-5 h-5"></i>
                                <span contenteditable="true" class="font-semibold uppercase tracking-wider text-xs">Knowledge Check</span>
                            </div>
                            <p contenteditable="true" class="text-sm font-medium text-slate-900">New Quiz Interaction Placeholder</p>
                        </div>`;
                    break;
                case 'flipcards':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'flipcards')" class="content-block mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 animate-in fade-in slide-in-from-bottom-2">
                            ${[1, 2, 3].map(i => `
                                <div class="flip-container h-[200px]">
                                    <div class="flip-card-inner">
                                        <div class="flip-card-front bg-indigo-600 text-white shadow-lg cursor-pointer" onclick="toggleFlip(this.parentElement)">
                                            <p contenteditable="true" class="text-xs font-bold uppercase tracking-widest opacity-70 mb-2" onclick="event.stopPropagation()">Question ${i}</p>
                                            <p contenteditable="true" class="text-sm font-medium" onclick="event.stopPropagation()">Click to reveal answer</p>
                                        </div>
                                        <div class="flip-card-back bg-white border-2 border-indigo-600 text-indigo-900 shadow-lg cursor-pointer" onclick="toggleFlip(this.parentElement)">
                                            <p contenteditable="true" class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-2" onclick="event.stopPropagation()">Answer</p>
                                            <p contenteditable="true" class="text-xs leading-relaxed" onclick="event.stopPropagation()">This is the detailed explanation for cards. You can customize this content.</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    break;
                case 'expandable':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'expandable')" class="content-block mt-8 space-y-4 animate-in fade-in slide-in-from-bottom-2">
                           <div class="bg-white border border-slate-200 rounded-xl p-6 hover:border-indigo-300 transition-colors">
                                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleExpand(this.parentElement, 'vertical')">
                                    <h4 contenteditable="true" class="font-bold text-slate-800" onclick="event.stopPropagation()">Vertical Expansion</h4>
                                    <i data-lucide="chevron-down" class="expand-icon w-4 h-4 text-slate-400 transition-transform"></i>
                                </div>
                                <div class="expand-vertical max-height-0 overflow-hidden transition-all">
                                    <p contenteditable="true" class="text-sm text-slate-600 leading-relaxed mt-4">This content is progressively revealed to the student to prevent cognitive overload.</p>
                                </div>
                           </div>
                        </div>`;
                    break;
                case 'gallery':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'gallery')" data-type="gallery" class="content-block mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-bottom-2">
                            ${[1, 2, 3, 4].map(i => `
                                <div class="quote-card template-classic border border-slate-200 p-5 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                                    <i data-lucide="quote" class="w-6 h-6 text-indigo-100 group-hover:text-indigo-600 transition-colors mb-4"></i>
                                    <p contenteditable="true" class="text-xs text-slate-600 italic leading-relaxed" onclick="event.stopPropagation()">"Design is not just what it looks like and feels like."</p>
                                    <p contenteditable="true" class="text-[10px] font-bold text-slate-400 mt-4 uppercase tracking-widest" onclick="event.stopPropagation()">— Steve Jobs</p>
                                </div>
                            `).join('')}
                        </div>`;
                    break;
                case 'sorting':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'sorting')" data-type="sorting" class="content-block mt-12 animate-in fade-in slide-in-from-bottom-2">
                             <h4 contenteditable="true" class="text-xs font-bold text-slate-400 uppercase mb-6 tracking-widest text-center">Categorization Exercise</h4>
                            <div class="flex gap-4 mb-8 justify-center flex-wrap">
                                <div id="p-${id}-1" contenteditable="true" draggable="true" ondragstart="handleDragStartSorting(event)" data-type="rocky" class="px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-full text-xs font-bold text-indigo-600 cursor-grab outline-none focus:ring-2 focus:ring-indigo-400">Mars</div>
                                <div id="p-${id}-2" contenteditable="true" draggable="true" ondragstart="handleDragStartSorting(event)" data-type="gas" class="px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-full text-xs font-bold text-indigo-600 cursor-grab outline-none focus:ring-2 focus:ring-indigo-400">Jupiter</div>
                                <div id="p-${id}-3" contenteditable="true" draggable="true" ondragstart="handleDragStartSorting(event)" data-type="rocky" class="px-4 py-2 bg-indigo-50 border border-indigo-100 rounded-full text-xs font-bold text-indigo-600 cursor-grab outline-none focus:ring-2 focus:ring-indigo-400">Earth</div>
                            </div>
                            <div class="grid grid-cols-2 gap-6">
                                <div ondragover="handleDragOverSorting(event)" ondrop="handleDropSorting(event)" data-accept="rocky" class="h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center p-4 transition-colors hover:border-indigo-300">
                                    <span contenteditable="true" class="text-[10px] font-bold text-slate-400 uppercase mb-4 outline-none">Rocky Planets</span>
                                </div>
                                <div ondragover="handleDragOverSorting(event)" ondrop="handleDropSorting(event)" data-accept="gas" class="h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center p-4 transition-colors hover:border-indigo-300">
                                    <span contenteditable="true" class="text-[10px] font-bold text-slate-400 uppercase mb-4 outline-none">Gas Giants</span>
                                </div>
                            </div>
                        </div>`;
                    break;
                case 'hotspots':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'hotspots')" data-type="hotspots" class="content-block mt-8 relative rounded-2xl overflow-hidden bg-slate-100 aspect-video animate-in fade-in slide-in-from-bottom-2 border border-slate-200 cursor-crosshair" onclick="moveActiveHotspot(event)">
                             <div class="absolute inset-0 flex items-center justify-center text-slate-300 pointer-events-none">
                                 <i data-lucide="image" class="w-20 h-20"></i>
                             </div>
                             <div class="hotspot" style="top: 30%; left: 45%;" onclick="event.stopPropagation(); handleHotspot(this, true)"></div>
                             <div class="hotspot" style="top: 60%; left: 20%;" onclick="event.stopPropagation(); handleHotspot(this, false)"></div>
                             <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur p-4 rounded-xl shadow-lg border border-white/20 hotspot-feedback pointer-events-none">
                                <p contenteditable="true" class="text-xs text-slate-500">Spot the intentional error in the diagram above.</p>
                             </div>
                        </div>`;
                    break;
                case 'sequence':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'sequence')" data-type="sequence" class="content-block mt-8 p-6 bg-slate-50 rounded-2xl border border-slate-200 animate-in fade-in slide-in-from-bottom-2">
                             <h4 contenteditable="true" class="text-xs font-bold text-slate-400 uppercase mb-6 tracking-widest text-center">Reorder Steps</h4>
                             <div class="space-y-3 cursor-move">
                                <div class="p-3 bg-white border border-slate-200 rounded-lg text-xs font-medium flex items-center gap-3">
                                    <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center text-[10px] font-bold text-slate-400">1</div>
                                    <span contenteditable="true">Observation & Question</span>
                                </div>
                                <div class="p-3 bg-white border border-slate-200 rounded-lg text-xs font-medium flex items-center gap-3">
                                    <div class="w-6 h-6 rounded bg-slate-50 flex items-center justify-center text-[10px] font-bold text-slate-400">2</div>
                                    <span contenteditable="true">Hypothesis Formation</span>
                                </div>
                             </div>
                             <button class="w-full mt-6 py-2 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-colors">Check Sequence</button>
                        </div>`;
                    break;
                case 'chart':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'chart')" data-type="chart" class="content-block mt-8 p-10 bg-white border border-slate-100 shadow-sm rounded-3xl animate-in fade-in slide-in-from-bottom-2">
                             <h4 contenteditable="true" class="text-xs font-bold text-slate-400 uppercase mb-12 text-center tracking-widest outline-none">Educational Data Trends</h4>
                             
                             <div class="flex">
                                <!-- Y Axis Title -->
                                <div class="y-axis-container">
                                    <span contenteditable="true" class="y-axis-label text-[9px] font-bold text-slate-300 uppercase tracking-widest outline-none">Success Rate (%)</span>
                                </div>
                                
                                <div class="flex-1 px-4">
                                    <div class="bar-chart-container h-48 border-b-2 border-slate-50 flex items-end gap-3 pb-2">
                                        <div class="bar-item group relative flex-1 bg-indigo-500 rounded-t-xl" style="height: 65%;">
                                            <div class="bar-tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-all pointer-events-none">65%</div>
                                        </div>
                                        <div class="bar-item group relative flex-1 bg-indigo-500 rounded-t-xl" style="height: 85%;">
                                            <div class="bar-tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[9px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-all pointer-events-none">85%</div>
                                        </div>
                                    </div>
                                    
                                    <!-- X Axis Labels -->
                                    <div class="x-axis-labels flex justify-around mt-3 text-[9px] font-bold text-slate-400 uppercase tracking-tight">
                                        <span contenteditable="true" class="outline-none">Cohort A</span>
                                        <span contenteditable="true" class="outline-none">Cohort B</span>
                                    </div>
                                    
                                    <!-- X Axis Title -->
                                    <div class="text-center mt-6">
                                        <span contenteditable="true" class="x-axis-title text-[9px] font-bold text-slate-300 uppercase tracking-widest outline-none">Student Demographics</span>
                                    </div>
                                </div>
                             </div>
                        </div>`;
                    break;
                case 'branching':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'branching')" data-type="branching" class="content-block mt-8 p-8 bg-gradient-to-br from-indigo-900 to-indigo-950 rounded-3xl text-white scenario-container animate-in fade-in slide-in-from-bottom-2 shadow-xl border border-indigo-800">
                             <div class="flex items-center gap-2 mb-6 text-indigo-400">
                                <i data-lucide="git-branch" class="w-4 h-4"></i>
                                <span contenteditable="true" class="text-[10px] font-bold uppercase tracking-widest">Branching Scenario</span>
                             </div>
                             <p contenteditable="true" class="scenario-text text-lg font-medium leading-relaxed mb-8">Scenario text here...</p>
                             <div class="scenario-buttons flex gap-3">
                                <button contenteditable="true" class="px-6 py-3 bg-white/10 hover:bg-white/20 border border-white/10 rounded-xl text-xs font-bold transition-all">Choice A</button>
                                <button contenteditable="true" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-xs font-bold transition-all shadow-lg shadow-indigo-500/20">Choice B</button>
                             </div>
                        </div>`;
                    break;
                case 'video':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'video')" data-type="video" class="content-block mt-8 relative rounded-3xl overflow-hidden bg-slate-900 aspect-video animate-in fade-in slide-in-from-bottom-2 border border-slate-800 shadow-2xl group/video">
                             <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none transition-all group-hover/video:text-indigo-400">
                                 <i data-lucide="video" class="w-20 h-20 mb-4 opacity-20 group-hover/video:opacity-100 transition-opacity"></i>
                                 <p class="text-xs font-bold uppercase tracking-widest opacity-40">Educational Video Player</p>
                             </div>
                             
                             <!-- UI Overlay Mock -->
                             <div class="absolute bottom-6 left-6 right-6 flex items-center gap-4 opacity-0 group-hover/video:opacity-100 transition-opacity translate-y-2 group-hover/video:translate-y-0 duration-300">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-lg">
                                    <i data-lucide="play" class="w-5 h-5 text-indigo-600 fill-indigo-600 ml-1"></i>
                                </div>
                                <div class="flex-1 h-1.5 bg-white/20 rounded-full overflow-hidden">
                                    <div class="w-1/3 h-full bg-indigo-500"></div>
                                </div>
                                <div class="text-[10px] font-bold text-white uppercase tracking-tighter">04:20 / 12:00</div>
                             </div>
                        </div>`;
                    break;
                case 'cloze':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'cloze')" data-type="cloze" class="content-block mt-8 p-8 bg-slate-50 border border-slate-200 rounded-2xl animate-in fade-in slide-in-from-bottom-2">
                            <div class="flex items-center gap-2 mb-6">
                                <i data-lucide="languages" class="w-4 h-4 text-indigo-600"></i>
                                <span contenteditable="true" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Cloze Activity</span>
                            </div>
                            
                            <div class="cloze-text text-lg text-slate-800 leading-loose">
                                The <span contenteditable="true" class="inline-block min-w-[80px] border-b-2 border-indigo-400 px-2 text-indigo-600 outline-none" data-answer="Earth">_____</span> revolves around the <span contenteditable="true" class="inline-block min-w-[80px] border-b-2 border-indigo-400 px-2 text-indigo-600 outline-none" data-answer="Sun">_____</span> in approximately 365 days.
                            </div>

                            <button onclick="handleClozeCheck(this.parentElement)" class="mt-8 px-6 py-2 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-50 transition-all shadow-sm">Check Answers</button>
                        </div>`;
                    break;
                case 'decision':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'decision')" data-type="decision" class="content-block mt-8 p-10 bg-white border border-slate-200 rounded-3xl animate-in fade-in slide-in-from-bottom-2 shadow-sm">
                            <div class="flex items-center gap-2 mb-6">
                                <i data-lucide="message-square-quote" class="w-4 h-4 text-indigo-600"></i>
                                <span contenteditable="true" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Decision Point</span>
                            </div>
                            <h3 contenteditable="true" class="text-xl font-bold text-slate-900 mb-4 leading-tight">Critical Scenario Heading</h3>
                            <p contenteditable="true" class="text-sm text-slate-600 leading-relaxed mb-8">Describe a complex situation here where the learner must make a choice between multiple valid perspectives.</p>
                            
                            <div class="choice-stack space-y-3">
                                <button class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left text-sm font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-between items-center group">
                                    <span contenteditable="true">Option A: First Perspective</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all"></i>
                                </button>
                                <button class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left text-sm font-medium hover:border-indigo-500 hover:bg-indigo-50 transition-all flex justify-between items-center group">
                                    <span contenteditable="true">Option B: Second Perspective</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all"></i>
                                </button>
                            </div>
                        </div>`;
                    break;
                case 'upload':
                    newBlockHtml = `
                        <div onmousedown="selectBlock(this, 'upload')" data-type="upload" class="content-block mt-8 animate-in fade-in slide-in-from-bottom-2" data-has-file="false">
                            <div class="upload-container">
                                <!-- STAGE 1: Drop Zone -->
                                <div class="glass-dropzone rounded-3xl p-12 flex flex-col items-center justify-center text-center cursor-pointer group" onclick="simulateFileUpload(this)">
                                    <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                                        <i data-lucide="upload-cloud" class="w-10 h-10"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">Upload Knowledge</h3>
                                    <p class="text-sm text-slate-500 max-w-sm">Drop PDF, Image, Video, or CSV here. We'll help you turn it into an interactive experience.</p>
                                    <div class="mt-8 flex gap-4 opacity-40">
                                        <i data-lucide="file-text" class="w-5 h-5"></i>
                                        <i data-lucide="image" class="w-5 h-5"></i>
                                        <i data-lucide="video" class="w-5 h-5"></i>
                                        <i data-lucide="table-2" class="w-5 h-5"></i>
                                    </div>
                                </div>

                                <!-- STAGE 2: Intent Selection (Hidden initially) -->
                                <div class="intent-selection hidden mt-8">
                                    <div class="text-center mb-10">
                                        <span class="text-xs font-black text-indigo-400 uppercase tracking-[0.2em] mb-3 block">File Processed: algorithm_basics.pdf</span>
                                        <h2 class="text-2xl font-bold text-slate-900">What should students DO with this file?</h2>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <!-- Understand -->
                                        <div class="intent-card rounded-2xl p-6" onclick="selectFileUploadIntent(this, 'understand')">
                                            <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center mb-4">
                                                <i data-lucide="book-open" class="w-5 h-5"></i>
                                            </div>
                                            <h4 class="font-bold text-slate-900 mb-1">📘 Understand</h4>
                                            <p class="text-[10px] text-slate-500 leading-relaxed mb-4">Auto Summary, Key Highlights, Visual Explanations.</p>
                                            <span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full uppercase tracking-tighter">Engagement ↑ 2.1x</span>
                                        </div>

                                        <!-- Practice -->
                                        <div class="intent-card rounded-2xl p-6" onclick="selectFileUploadIntent(this, 'practice')">
                                            <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center mb-4">
                                                <i data-lucide="brain" class="w-5 h-5"></i>
                                            </div>
                                            <h4 class="font-bold text-slate-900 mb-1">🧠 Practice</h4>
                                            <p class="text-[10px] text-slate-500 leading-relaxed mb-4">Generate Quizzes, Fill in the Blanks, Spot the Error.</p>
                                            <span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full uppercase tracking-tighter">Retention ↑ 4x</span>
                                        </div>

                                        <!-- Apply -->
                                        <div class="intent-card rounded-2xl p-6" onclick="selectFileUploadIntent(this, 'apply')">
                                            <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center mb-4">
                                                <i data-lucide="target" class="w-5 h-5"></i>
                                            </div>
                                            <h4 class="font-bold text-slate-900 mb-1">🎯 Apply</h4>
                                            <p class="text-[10px] text-slate-500 leading-relaxed mb-4">Real-World Scenarios, Decision Trees, Case Studies.</p>
                                        </div>

                                        <!-- Explore -->
                                        <div class="intent-card rounded-2xl p-6" onclick="selectFileUploadIntent(this, 'explore')">
                                            <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center mb-4">
                                                <i data-lucide="eye" class="w-5 h-5"></i>
                                            </div>
                                            <h4 class="font-bold text-slate-900 mb-1">👁️ Explore</h4>
                                            <p class="text-[10px] text-slate-500 leading-relaxed mb-4">Interactive Hotspots, Step-by-Step Reveal, Annotations.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- STAGE 3: Final Experience View (Hidden initially) -->
                                <div class="final-experience hidden mt-8">
                                    <div id="experience-canvas"></div>
                                </div>
                            </div>
                        </div>`;
                    break;
            }
            // Insert relative to the target (trigger or selected block)
            if (newBlockHtml) {
                targetContainer.insertAdjacentHTML(position, newBlockHtml);
                if (!injectBelow) trigger.innerText = '';
                hideSlashMenu();
                lucide.createIcons();
                const newBlock = (position === 'afterend') ? targetContainer.nextElementSibling : targetContainer.previousElementSibling;
                newBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- DASHBOARD LOGIC ---
        let currentDevMode = 'edit';
        function setDeviceMode(mode) {
            const frame = document.getElementById('simulatorFrame');
            const main = document.getElementById('editorMain');
            const home = document.getElementById('mobile-home');

            if (currentDevMode === mode) {
                mode = 'edit';
            }
            currentDevMode = mode;

            // UI Update
            ['tablet', 'mobile'].forEach(m => {
                const btn = document.getElementById(`dev-${m}`);
                if (btn) {
                    btn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
                    btn.classList.add('text-slate-400');
                }
            });

            if (mode !== 'edit') {
                const activeBtn = document.getElementById(`dev-${mode}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-slate-400');
                    activeBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
                }
            }

            // Reset States
            if (home) home.classList.add('hidden');
            main.classList.remove('bg-slate-50/20');
            main.classList.add('bg-white');
            frame.classList.remove('shadow-[0_0_50px_-12px_rgba(0,0,0,0.1)]');
            frame.style.border = 'none';
            frame.style.borderRadius = 'var(--radius-block)';

            if (mode === 'edit') {
                frame.style.maxWidth = '800px';
                frame.style.paddingLeft = '32px';
                frame.style.paddingRight = '32px';
            } else {
                main.classList.replace('bg-white', 'bg-slate-50/20');
                frame.classList.add('shadow-[0_0_50px_-12px_rgba(0,0,0,0.1)]');
                if (mode === 'tablet') {
                    frame.style.maxWidth = '600px';
                    frame.style.paddingLeft = '32px';
                    frame.style.paddingRight = '32px';
                    frame.style.border = '12px solid #1e293b';
                    frame.style.borderRadius = '24px';
                } else if (mode === 'mobile') {
                    frame.style.maxWidth = '375px';
                    frame.style.paddingLeft = '20px';
                    frame.style.paddingRight = '20px';
                    frame.style.border = '12px solid #1e293b';
                    frame.style.borderRadius = '40px';
                    if (home) home.classList.remove('hidden');
                }
            }
        }

        // --- SMART UPLOAD LOGIC ---
        function simulateFileUpload(container) {
            const block = container.closest('.content-block');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center">
                    <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
                    <p class="text-sm font-bold text-slate-900">Uploading algorithm_basics.pdf...</p>
                    <p class="text-xs text-slate-400 mt-1">Analyzing content for interactive triggers</p>
                </div>
            `;

            setTimeout(() => {
                block.setAttribute('data-has-file', 'true');
                block.querySelector('.glass-dropzone').classList.add('hidden');
                const intentSection = block.querySelector('.intent-selection');
                intentSection.classList.remove('hidden');
                intentSection.classList.add('animate-in', 'fade-in', 'zoom-in-95', 'duration-500');

                // Update sidebar if this block is selected
                if (selectedBlockElement === block) renderUploadSettings(document.getElementById('block-settings-render-area'));
                lucide.createIcons();
            }, 1200);
        }

        function selectFileUploadIntent(card, intent) {
            const block = card.closest('.content-block');
            block.setAttribute('data-intent', intent);

            // Highlight selected card
            block.querySelectorAll('.intent-card').forEach(c => c.classList.remove('ring-2', 'ring-indigo-600', 'bg-indigo-50/50'));
            card.classList.add('ring-2', 'ring-indigo-600', 'bg-indigo-50/50');

            const intentSection = block.querySelector('.intent-selection');
            const finalExp = block.querySelector('.final-experience');
            const canvas = block.querySelector('#experience-canvas');

            intentSection.classList.add('opacity-0', 'pointer-events-none');

            setTimeout(() => {
                intentSection.classList.add('hidden');
                finalExp.classList.remove('hidden');
                finalExp.classList.add('animate-in', 'fade-in', 'slide-in-from-bottom-4', 'duration-700');

                // Render the specific "Praband-way" experience
                renderSmartExperience(canvas, intent);
                lucide.createIcons();
            }, 500);
        }

        function renderSmartExperience(canvas, intent) {
            switch (intent) {
                case 'understand':
                    canvas.innerHTML = `
                        <div class="space-y-6">
                            <div class="p-6 bg-slate-900 rounded-3xl text-white">
                                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-4 block">AI Executive Summary</span>
                                <h3 class="text-xl font-bold mb-4">The core of Data Structures isn't storage, it's efficient retrieval.</h3>
                                <p class="text-sm text-slate-400 leading-relaxed">This PDF details the logarithmic nature of Binary Search Trees. Key takeaway: Every balancing rotation maintains the O(log n) efficiency guarantee.</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="living-doc-section">
                                    <h4 class="font-bold text-slate-900 mb-2">Linear vs Non-Linear</h4>
                                    <p class="text-xs text-slate-500 italic leading-relaxed">"Arrays are sequential, while trees are hierarchical."</p>
                                    <button class="mt-3 text-[10px] font-bold text-indigo-600 flex items-center gap-1">SEE HIGHLIGHTS <i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                                </div>
                                <div class="living-doc-section">
                                    <h4 class="font-bold text-slate-900 mb-2">Memory Allocation</h4>
                                    <p class="text-xs text-slate-500 italic leading-relaxed">"Pointers define the skeleton of the tree."</p>
                                    <button class="mt-3 text-[10px] font-bold text-indigo-600 flex items-center gap-1">SEE HIGHLIGHTS <i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'practice':
                    canvas.innerHTML = `
                        <div class="p-8 bg-indigo-50 border border-indigo-100 rounded-3xl">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-indigo-600 text-white rounded-xl flex items-center justify-center">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-indigo-900">Knowledge Check (AI Generated)</h4>
                                    <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">Based on Page 4 of algorithm_basics.pdf</p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-700 font-medium mb-6 leading-relaxed">According to the document, why does an AVL Tree perform a Left-Right rotation?</p>
                            <div class="space-y-3">
                                <button class="w-full p-4 bg-white border border-slate-200 rounded-xl text-left text-xs font-semibold hover:border-indigo-500 transition-all flex justify-between">
                                    When the right subtree is skewed
                                    <i data-lucide="circle" class="w-4 h-4 text-slate-200"></i>
                                </button>
                                <button class="w-full p-4 bg-white border border-indigo-600 ring-4 ring-indigo-500/10 rounded-xl text-left text-xs font-semibold flex justify-between">
                                    When the left-child's right subtree is taller
                                    <i data-lucide="check-circle-2" class="w-4 h-4 text-indigo-600"></i>
                                </button>
                                <button class="w-full p-4 bg-white border border-slate-200 rounded-xl text-left text-xs font-semibold hover:border-indigo-500 transition-all flex justify-between">
                                    When the total height exceeds 10 nodes
                                    <i data-lucide="circle" class="w-4 h-4 text-slate-200"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                case 'explore':
                    canvas.innerHTML = `
                         <div class="relative rounded-3xl overflow-hidden bg-slate-100 aspect-video border border-slate-200">
                             <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&q=80&w=2070')] bg-cover bg-center opacity-60"></div>
                             <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                             
                             <!-- AI Generated Hotspot -->
                             <div class="hotspot" style="top: 40%; left: 30%;">
                                 <div class="marker-popup" style="display:block">
                                     <p class="font-black uppercase tracking-tighter mb-1">Critical Insight</p>
                                     <p class="text-slate-500 leading-tight">This circuit layout mirrors the "Array in Memory" concept discussed on page 12.</p>
                                 </div>
                             </div>
                             
                             <div class="absolute bottom-6 left-6 right-6">
                                 <h4 class="text-white font-bold mb-2">Visual Walkthrough: Memory Topology</h4>
                                 <p class="text-slate-400 text-xs leading-relaxed">We've mapped the PDF concepts to this real-world hardware image. Hover over the red pulses to explore.</p>
                             </div>
                         </div>
                    `;
                    break;
                case 'apply':
                    canvas.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex items-center gap-3 p-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-2xl">
                                <i data-lucide="alert-circle" class="w-5 h-5 text-orange-600"></i>
                                <p class="text-xs font-bold text-orange-900 uppercase tracking-tight">Theory-to-Practice Pivot</p>
                            </div>
                            <div class="p-8 bg-white border border-slate-200 rounded-3xl shadow-sm">
                                <h4 class="text-lg font-bold text-slate-900 mb-4">Case Study: The Synchronous Failure</h4>
                                <p class="text-sm text-slate-600 leading-relaxed mb-6">Based on the 'Edge Cases' section of your upload, imagine a high-traffic banking system where a lock contention occurs. Given the Binary Tree logic in the PDF, how would you resolve this?</p>
                                <div class="space-y-3">
                                    <button class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left text-xs font-semibold hover:border-indigo-500 transition-all flex justify-between items-center group">
                                        Implement a Semaphored Queue
                                        <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all"></i>
                                    </button>
                                    <button class="w-full p-4 border-2 border-slate-100 rounded-2xl text-left text-xs font-semibold hover:border-indigo-500 transition-all flex justify-between items-center group">
                                        Switch to a Red-Black configuration
                                        <i data-lucide="arrow-right" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-all"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    canvas.innerHTML = `<div class="p-12 text-center text-slate-400 border-2 border-dashed border-slate-100 rounded-3xl">This experience module is being initialized...</div>`;
            }
        }

        // Initialize Observer for entrance animations
        const entranceObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-entrance');
                    entranceObserver.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        function watchBlocks() {
            document.querySelectorAll('.content-block').forEach(block => {
                entranceObserver.observe(block);
            });
        }

        // Watch existing blocks on load
        window.addEventListener('load', watchBlocks);

        // Also watch blocks added via slash menu
        const originalInsert = insertCreatedBlock;
        insertCreatedBlock = function (type, injectBelow) {
            originalInsert(type, injectBelow);
            const blocks = document.querySelectorAll('.content-block');
            entranceObserver.observe(blocks[blocks.length - 1]);
        };
    </script>

    };
    </script>
</body>

</html>
